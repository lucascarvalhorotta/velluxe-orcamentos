<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velluxe Decor - Sistema de Or√ßamentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-serif { font-family: 'Cormorant Garamond', serif; }
        /* Garante que o conte√∫do do PDF n√£o seja cortado */
        .pdf-content { box-sizing: border-box; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ==================== STATUS DO PIPELINE ====================
        const STATUS_PIPELINE = [
          { id: 'rascunho', nome: 'Rascunho', cor: 'bg-gray-500', icon: 'üìù' },
          { id: 'enviado', nome: 'Enviado', cor: 'bg-blue-500', icon: 'üì§' },
          { id: 'aprovado', nome: 'Aprovado', cor: 'bg-green-500', icon: '‚úÖ' },
          { id: 'producao', nome: 'Em Produ√ß√£o', cor: 'bg-yellow-500', icon: 'üî®' },
          { id: 'pronto', nome: 'Pronto p/ Entrega', cor: 'bg-purple-500', icon: 'üì¶' },
          { id: 'entregue', nome: 'Entregue', cor: 'bg-teal-500', icon: 'üöö' },
          { id: 'fechado', nome: 'Fechado/Pago', cor: 'bg-emerald-600', icon: 'üí∞' },
          { id: 'cancelado', nome: 'Cancelado', cor: 'bg-red-500', icon: '‚ùå' }
        ];

        const getStatusInfo = (statusId) => STATUS_PIPELINE.find(s => s.id === statusId) || STATUS_PIPELINE[0];

        // ==================== SUPABASE CONFIG ====================
        const SUPABASE_URL = 'https://hukrkhwzziccbrtzggay.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1a3JraHd6emljY2JydHpnZ2F5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNDgzNzksImV4cCI6MjA4NTYyNDM3OX0.GKedeYQBbPxRzKz_9keK4BEnaSgvBULLLhffD89W-C0';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ==================== BASE DE PRODUTOS ====================
        const produtosBase = {
          tecidos: [
    { codigo: 'V-FLU', nome: 'Persiana Vertical Fluence', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 65.90, unidade: 'm2' },
    { codigo: 'V-NUA', nome: 'Persiana Vertical Nuance Premium / Contraste', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 69.90, unidade: 'm2' },
    { codigo: 'V-ATE', nome: 'Persiana Vertical Atenas / Gr√©cia', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 85.90, unidade: 'm2' },
    { codigo: 'V-SAL', nome: 'Persiana Vertical Salta', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 88.90, unidade: 'm2' },
    { codigo: 'V-PAR', nome: 'Persiana Vertical Paris / Madri / Turim / Veneza', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 97.90, unidade: 'm2' },
    { codigo: 'V-SAN', nome: 'Persiana Vertical San Marino / Firenze / Roma / Napoli', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 97.90, unidade: 'm2' },
    { codigo: 'V-VER', nome: 'Persiana Vertical Verona / Potenza / Catania / Mosaico', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 99.90, unidade: 'm2' },
    { codigo: 'V-NAT', nome: 'Persiana Vertical Natura / Cedro / Alfa', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 109.00, unidade: 'm2' },
    { codigo: 'V-AMB', nome: 'Persiana Vertical New Arezzo Mescla Bege/Creme', categoria: 'Vertical Transl√∫cida', largura: 0.09, preco: 115.00, unidade: 'm2' },
    { codigo: 'VBK-SOL', nome: 'Persiana Vertical BK Soleil', categoria: 'Vertical Blackout', largura: 0.09, preco: 134.00, unidade: 'm2' },
    { codigo: 'VBK-SAL', nome: 'Persiana Vertical BK Salta', categoria: 'Vertical Blackout', largura: 0.09, preco: 139.00, unidade: 'm2' },
    { codigo: 'VBK-ALF', nome: 'Persiana Vertical BK Alfa / Toscana / Berlim / Denver', categoria: 'Vertical Blackout', largura: 0.09, preco: 139.00, unidade: 'm2' },
    { codigo: 'VBK-CED', nome: 'Persiana Vertical BK Cedro / Arezzo Mescla', categoria: 'Vertical Blackout', largura: 0.09, preco: 147.00, unidade: 'm2' },
    { codigo: 'VBK-SOF', nome: 'Persiana Vertical BK Soft / Rustic', categoria: 'Vertical Blackout', largura: 0.09, preco: 159.00, unidade: 'm2' },
    { codigo: 'VPVC-SLI', nome: 'Persiana Vertical PVC Liso SLIM', categoria: 'Vertical PVC', largura: 0.09, preco: 119.00, unidade: 'm2' },
    { codigo: 'VPVC-CON', nome: 'Persiana Vertical PVC Liso CONTRACT', categoria: 'Vertical PVC', largura: 0.09, preco: 129.00, unidade: 'm2' },
    { codigo: 'VPVC-RUS', nome: 'Persiana Vertical PVC Rustic', categoria: 'Vertical PVC', largura: 0.09, preco: 139.00, unidade: 'm2' },
    { codigo: 'VPVC-FRO', nome: 'Persiana Vertical PVC Frost', categoria: 'Vertical PVC', largura: 0.09, preco: 155.00, unidade: 'm2' },
    { codigo: 'VPVC-MAD', nome: 'Persiana Vertical PVC Madeira', categoria: 'Vertical PVC', largura: 0.09, preco: 169.00, unidade: 'm2' },
    { codigo: 'VPVC-CHE', nome: 'Persiana Vertical PVC Chelsea / Soho / Amsterdam', categoria: 'Vertical PVC', largura: 0.09, preco: 179.00, unidade: 'm2' },
    { codigo: 'H25-LIS', nome: 'Persiana Horizontal 25mm Lisa (0.21)', categoria: 'Horizontal 25mm', largura: 1.00, preco: 129.90, unidade: 'm2' },
    { codigo: 'H25-MET', nome: 'Persiana Horizontal 25mm Metalizada', categoria: 'Horizontal 25mm', largura: 1.00, preco: 133.90, unidade: 'm2' },
    { codigo: 'H25-TEX', nome: 'Persiana Horizontal 25mm Texturizada', categoria: 'Horizontal 25mm', largura: 1.00, preco: 149.00, unidade: 'm2' },
    { codigo: 'H25-PER', nome: 'Persiana Horizontal 25mm Perfurada / Perolizada', categoria: 'Horizontal 25mm', largura: 1.00, preco: 159.00, unidade: 'm2' },
    { codigo: 'H25-MAD', nome: 'Persiana Horizontal 25mm Madeirada / Martelada / Printing', categoria: 'Horizontal 25mm', largura: 1.00, preco: 179.00, unidade: 'm2' },
    { codigo: 'H25-SLI', nome: 'Persiana Horizontal 25mm Lisa SLIM (0.18)', categoria: 'Horizontal 25mm', largura: 1.00, preco: 119.90, unidade: 'm2' },
    { codigo: 'H16-LIS', nome: 'Persiana Horizontal 16mm Lisa', categoria: 'Horizontal 16mm', largura: 1.00, preco: 159.90, unidade: 'm2' },
    { codigo: 'H16-MET', nome: 'Persiana Horizontal 16mm Metalizada', categoria: 'Horizontal 16mm', largura: 1.00, preco: 163.90, unidade: 'm2' },
    { codigo: 'H50-ALC', nome: 'Persiana PH 50mm Alum√≠nio c/ Cadar√ßo', categoria: 'Horizontal 50mm', largura: 1.00, preco: 229.00, unidade: 'm2' },
    { codigo: 'H50-ALF', nome: 'Persiana PH 50mm Alum√≠nio c/ Fita Decorativa', categoria: 'Horizontal 50mm', largura: 1.00, preco: 269.00, unidade: 'm2' },
    { codigo: 'H50-PVC', nome: 'Persiana PH 50mm PVC Liso c/ Cadar√ßo', categoria: 'Horizontal 50mm', largura: 1.00, preco: 269.00, unidade: 'm2' },
    { codigo: 'H50-MAD', nome: 'Persiana PH 50mm Madeira Sint√©tica c/ Cadar√ßo', categoria: 'Horizontal 50mm', largura: 1.00, preco: 447.00, unidade: 'm2' },
    { codigo: 'RO-APO', nome: 'Persiana Rol√¥ Apolo', categoria: 'Rol√¥', largura: 2.00, preco: 138.00, unidade: 'm2' },
    { codigo: 'RO-MAL', nome: 'Persiana Rol√¥ Malta', categoria: 'Rol√¥', largura: 2.80, preco: 139.00, unidade: 'm2' },
    { codigo: 'RO-SCR3', nome: 'Persiana Rol√¥ Screen 3%', categoria: 'Rol√¥ Screen', largura: 3.00, preco: 159.00, unidade: 'm2' },
    { codigo: 'RBK-LIS', nome: 'Persiana Rol√¥ BK Lisboa', categoria: 'Rol√¥ Blackout', largura: 2.80, preco: 185.00, unidade: 'm2' },
    { codigo: 'RBK-PRE', nome: 'Persiana Rol√¥ BK Prestige', categoria: 'Rol√¥ Blackout', largura: 2.80, preco: 198.00, unidade: 'm2' },
    { codigo: 'DV-STD', nome: 'Persiana Double Vision Transl√∫cida', categoria: 'Double Vision', largura: 2.25, preco: 235.00, unidade: 'm2' },
    { codigo: 'DV-MAG', nome: 'Persiana Double Vision Magia Semi-BK', categoria: 'Double Vision', largura: 2.80, preco: 435.00, unidade: 'm2' },
    { codigo: 'DV-SHA', nome: 'Persiana Shangrila White', categoria: 'Double Vision', largura: 3.00, preco: 588.00, unidade: 'm2' },
    { codigo: 'RM-APO', nome: 'Persiana Romana Apolo', categoria: 'Romana', largura: 2.00, preco: 172.00, unidade: 'm2' },
    { codigo: 'RM-SCR3', nome: 'Persiana Romana Screen 3%', categoria: 'Romana', largura: 3.00, preco: 198.00, unidade: 'm2' },
    { codigo: 'RBK-ROM', nome: 'Persiana Romana BK Lisboa', categoria: 'Romana Blackout', largura: 2.80, preco: 232.00, unidade: 'm2' },  
            { codigo: '4001', nome: 'Semi Blackout Marfim', categoria: 'Blackout', largura: 2.80, preco: 25.10, unidade: 'metro' },
            { codigo: '4002', nome: 'Semi Blackout Cinza Escuro', categoria: 'Blackout', largura: 2.80, preco: 25.10, unidade: 'metro' },
            { codigo: '4004', nome: 'Semi Blackout Branco', categoria: 'Blackout', largura: 2.80, preco: 31.20, unidade: 'metro' },
            { codigo: '4005', nome: 'Blackout Branco', categoria: 'Blackout', largura: 2.80, preco: 28.20, unidade: 'metro' },
            { codigo: '4006', nome: 'Blackout Marfim', categoria: 'Blackout', largura: 2.80, preco: 28.20, unidade: 'metro' },
            { codigo: '4007', nome: 'Blackout Oceano', categoria: 'Blackout', largura: 2.80, preco: 29.30, unidade: 'metro' },
            { codigo: '4009', nome: 'Blackout Preto', categoria: 'Blackout', largura: 2.80, preco: 29.30, unidade: 'metro' },
            { codigo: '4011', nome: 'Blackout Cinza Escuro', categoria: 'Blackout', largura: 2.80, preco: 29.30, unidade: 'metro' },
            { codigo: '4014', nome: 'Blackout Cinza Claro', categoria: 'Blackout', largura: 2.80, preco: 29.30, unidade: 'metro' },
            { codigo: '4015', nome: 'Blackout Rafia Marfim', categoria: 'Blackout', largura: 2.80, preco: 69.70, unidade: 'metro' },
            { codigo: '4016', nome: 'Blackout Rafia Cinza', categoria: 'Blackout', largura: 2.80, preco: 69.70, unidade: 'metro' },
            { codigo: '4017', nome: 'Blackout Nair√≥bi Marfim', categoria: 'Blackout', largura: 2.80, preco: 67.70, unidade: 'metro' },
            { codigo: '4018', nome: 'Blackout Santorine Bege', categoria: 'Blackout', largura: 2.80, preco: 65.70, unidade: 'metro' },
            { codigo: '4019', nome: 'Blackout Santorine Cinza', categoria: 'Blackout', largura: 2.80, preco: 65.70, unidade: 'metro' },
            { codigo: '4020', nome: 'Blackout Veludo Brilho Areia', categoria: 'Blackout', largura: 2.80, preco: 35.80, unidade: 'metro' },
            { codigo: '4021', nome: 'Blackout Veludo Brilho Cinza', categoria: 'Blackout', largura: 2.80, preco: 35.80, unidade: 'metro' },
            { codigo: '4022', nome: 'Blackout 100% Cinza Escuro', categoria: 'Blackout', largura: 2.80, preco: 52.00, unidade: 'metro' },
            { codigo: '4023', nome: 'Blackout 100% Branco', categoria: 'Blackout', largura: 2.80, preco: 52.00, unidade: 'metro' },
            { codigo: '4024', nome: 'Blackout 100% Marfim', categoria: 'Blackout', largura: 2.80, preco: 52.00, unidade: 'metro' },
            { codigo: '4025', nome: 'Blackout 100% Cinza', categoria: 'Blackout', largura: 2.80, preco: 52.00, unidade: 'metro' },
            { codigo: '4026', nome: 'Blackout 100% Dupla Face Branco', categoria: 'Blackout', largura: 2.80, preco: 48.20, unidade: 'metro' },
            { codigo: '4027', nome: 'Blackout 100% Dupla Face Marfim', categoria: 'Blackout', largura: 2.80, preco: 48.20, unidade: 'metro' },
            { codigo: '4037', nome: 'BLACKOUT 100% CORDOBA PRATA', categoria: 'Blackout', largura: 2.80, preco: 46.80, unidade: 'metro' },
            { codigo: '4040', nome: 'Forro Poliester M√©dio Branco', categoria: 'Forro', largura: 2.80, preco: 22.50, unidade: 'metro' },
            { codigo: '4041', nome: 'Forro Poliester M√©dio Marfim', categoria: 'Forro', largura: 2.80, preco: 22.50, unidade: 'metro' },
            { codigo: '4044', nome: 'Forro Microfibra Branco', categoria: 'Forro', largura: 2.80, preco: 9.90, unidade: 'metro' },
            { codigo: '4045', nome: 'Forro Microfibra Off White', categoria: 'Forro', largura: 2.80, preco: 9.90, unidade: 'metro' },
            { codigo: '4046', nome: 'Forro Microfibra Areia', categoria: 'Forro', largura: 2.80, preco: 9.90, unidade: 'metro' },
            { codigo: '4047', nome: 'Forro Microfibra Marfim', categoria: 'Forro', largura: 2.80, preco: 9.90, unidade: 'metro' },
            { codigo: '4057', nome: 'Voil Flame Branco', categoria: 'Voil', largura: 2.80, preco: 20.20, unidade: 'metro' },
            { codigo: '4058', nome: 'Voil Flame Marfim', categoria: 'Voil', largura: 2.80, preco: 20.20, unidade: 'metro' },
            { codigo: '4059', nome: 'Voal Flame Bege', categoria: 'Voil', largura: 2.80, preco: 20.20, unidade: 'metro' },
            { codigo: '4060', nome: 'Voal Flame Cinza', categoria: 'Voil', largura: 2.80, preco: 20.20, unidade: 'metro' },
            { codigo: '4062', nome: 'Oxford Branco', categoria: 'Oxford', largura: 2.80, preco: 20.40, unidade: 'metro' },
            { codigo: '4063', nome: 'Oxford Marfim', categoria: 'Oxford', largura: 2.80, preco: 20.40, unidade: 'metro' },
            { codigo: '4064', nome: 'Oxford Cinza', categoria: 'Oxford', largura: 2.80, preco: 20.40, unidade: 'metro' },
            { codigo: '5001', nome: 'Renda Verona Areia', categoria: 'Renda', largura: 2.80, preco: 37.50, unidade: 'metro' },
            { codigo: '5003', nome: 'Renda Verona Bege Duna', categoria: 'Renda', largura: 2.80, preco: 37.50, unidade: 'metro' },
            { codigo: '5005', nome: 'Renda Verona Cinza', categoria: 'Renda', largura: 2.80, preco: 37.50, unidade: 'metro' },
            { codigo: '5010', nome: 'Renda Genova Natural', categoria: 'Renda', largura: 2.80, preco: 51.10, unidade: 'metro' },
            { codigo: '5011', nome: 'Voal Bellini Branco', categoria: 'Voil', largura: 3.00, preco: 14.30, unidade: 'metro' },
            { codigo: '5012', nome: 'Renda Genova Cascalho', categoria: 'Renda', largura: 2.80, preco: 51.10, unidade: 'metro' },
            { codigo: '5013', nome: 'Voal Bellini Areia', categoria: 'Voil', largura: 3.00, preco: 14.30, unidade: 'metro' },
            { codigo: '5015', nome: 'Voal Bellini Fendi', categoria: 'Voil', largura: 3.00, preco: 14.30, unidade: 'metro' },
            { codigo: '5018', nome: 'Renda Veneza Branco', categoria: 'Renda', largura: 2.80, preco: 49.50, unidade: 'metro' },
            { codigo: '5019', nome: 'Voal Monaco Natural', categoria: 'Voil', largura: 3.00, preco: 22.50, unidade: 'metro' },
            { codigo: '5021', nome: 'Voal Monaco Areia', categoria: 'Voil', largura: 3.00, preco: 22.50, unidade: 'metro' },
            { codigo: '5028', nome: 'Voil IP2 Areia', categoria: 'Voil', largura: 3.00, preco: 33.00, unidade: 'metro' },
            { codigo: '5032', nome: 'Voil IP2 Branco', categoria: 'Voil', largura: 3.00, preco: 33.00, unidade: 'metro' },
            { codigo: '5046', nome: 'Voal IP3 Branco', categoria: 'Voil', largura: 3.00, preco: 40.50, unidade: 'metro' },
            { codigo: '5054', nome: 'Voal N√°poles Branco', categoria: 'Voil', largura: 3.00, preco: 36.00, unidade: 'metro' },
            { codigo: '5059', nome: 'Atacama Branco', categoria: 'Linho', largura: 3.00, preco: 49.50, unidade: 'metro' },
            { codigo: '5061', nome: 'Linho Cairo Areia', categoria: 'Linho', largura: 3.00, preco: 34.50, unidade: 'metro' },
            { codigo: '5062', nome: 'Linho Cairo Bege Duna', categoria: 'Linho', largura: 3.00, preco: 34.50, unidade: 'metro' },
            { codigo: '5063', nome: 'Linho Cairo Cinza', categoria: 'Linho', largura: 3.00, preco: 34.50, unidade: 'metro' },
            { codigo: '5064', nome: 'Ravena Branco', categoria: 'Linho', largura: 3.00, preco: 48.00, unidade: 'metro' },
            { codigo: '11317', nome: 'Voil Liso Branco', categoria: 'Voil', largura: 3.00, preco: 11.60, unidade: 'metro' },
            { codigo: '13924', nome: 'Voil Snow Branco', categoria: 'Voil', largura: 3.00, preco: 14.20, unidade: 'metro' },
            { codigo: '13968', nome: 'Voil Unique Branco', categoria: 'Voil', largura: 3.00, preco: 25.00, unidade: 'metro' },
            { codigo: '14423', nome: 'Linho Moorea Branco', categoria: 'Linho', largura: 3.00, preco: 48.10, unidade: 'metro' },
            { codigo: '15632', nome: 'Linho Absoluto Linho', categoria: 'Linho', largura: 3.00, preco: 91.40, unidade: 'metro' },
            { codigo: '15639', nome: 'Linho Gaia Linho', categoria: 'Linho', largura: 3.00, preco: 40.70, unidade: 'metro' },
            { codigo: '15649', nome: 'Boucle Cortina Loft Off White', categoria: 'Boucle', largura: 3.00, preco: 62.00, unidade: 'metro' },
            { codigo: '15735', nome: 'Boucle Resort Linho', categoria: 'Boucle', largura: 3.00, preco: 34.30, unidade: 'metro' },
          ],
          aviamentos: [
    { codigo: 'BD-ALU', nome: 'Band√¥ Alum√≠nio Revestido', categoria: 'Band√¥', preco: 35.00, unidade: 'm2' },
    { codigo: 'BD-PVC', nome: 'Band√¥ PVC (Tabaco/Bege/Cinza)', categoria: 'Band√¥', preco: 49.50, unidade: 'm2' },
    { codigo: 'TRI-VER', nome: 'Trilho Vertical Frisado Montado', categoria: 'Trilho', preco: 69.00, unidade: 'metro' },
    { codigo: 'AFA-CUR', nome: 'Afastador Curto 5x5 (Branco)', categoria: 'Suporte', preco: 3.95, unidade: 'unidade' },
    { codigo: 'AFA-LON', nome: 'Afastador Longo 5x7 (Branco)', categoria: 'Suporte', preco: 4.95, unidade: 'unidade' },
    { codigo: 'BOX-90', nome: 'Caixa Box 90mm (Branca)', categoria: 'Rol√¥', preco: 148.00, unidade: 'metro' },
            { codigo: 'TR-S', nome: 'Trilho Sui√ßo Simples', categoria: 'Trilho', preco: 6.00, unidade: 'metro' },
            { codigo: 'TR-SA', nome: 'Trilho Sui√ßo Simples c/ Aba', categoria: 'Trilho', preco: 9.65, unidade: 'metro' },
            { codigo: 'TR-D', nome: 'Trilho Sui√ßo Duplo', categoria: 'Trilho', preco: 19.20, unidade: 'metro' },
            { codigo: 'TR-DA', nome: 'Trilho Sui√ßo Duplo Alongado', categoria: 'Trilho', preco: 27.10, unidade: 'metro' },
            { codigo: 'TR-T', nome: 'Trilho Sui√ßo Triplo', categoria: 'Trilho', preco: 28.80, unidade: 'metro' },
            { codigo: 'PR-S', nome: 'Presilha Trilho Simples', categoria: 'Presilha', preco: 1.70, unidade: 'unidade' },
            { codigo: 'PR-SA', nome: 'Presilha Trilho Simples c/ Aba', categoria: 'Presilha', preco: 1.90, unidade: 'unidade' },
            { codigo: 'PR-D', nome: 'Presilha Trilho Duplo', categoria: 'Presilha', preco: 2.00, unidade: 'unidade' },
            { codigo: 'PR-T', nome: 'Presilha Trilho Triplo', categoria: 'Presilha', preco: 3.60, unidade: 'unidade' },
            { codigo: 'DL-R', nome: 'Deslizante Redondo (100un)', categoria: 'Deslizante', preco: 15.50, unidade: 'pacote' },
            { codigo: 'DL-Q', nome: 'Deslizante Quadrado (100un)', categoria: 'Deslizante', preco: 17.50, unidade: 'pacote' },
            { codigo: 'DL-C', nome: 'Deslizante Click (100un)', categoria: 'Deslizante', preco: 29.00, unidade: 'pacote' },
            { codigo: 'DL-FF', nome: 'Deslizante Fita F√°cil (100un)', categoria: 'Deslizante', preco: 29.00, unidade: 'pacote' },
            { codigo: 'DL-W', nome: 'Deslizante Wave (100un)', categoria: 'Deslizante', preco: 27.30, unidade: 'pacote' },
            { codigo: 'FT-FF', nome: 'Fita F√°cil', categoria: 'Fita', preco: 3.00, unidade: 'metro' },
            { codigo: 'FT-FFB', nome: 'Fita F√°cil Bella', categoria: 'Fita', preco: 3.90, unidade: 'metro' },
            { codigo: 'FT-W2', nome: 'Fita Wave 2x1 Regular', categoria: 'Fita', preco: 8.10, unidade: 'metro' },
            { codigo: 'FT-W3', nome: 'Fita Wave 3x1 Regular', categoria: 'Fita', preco: 8.10, unidade: 'metro' },
            { codigo: 'ET-P10', nome: 'Entretela Pl√°stica 10cm', categoria: 'Entretela', preco: 1.55, unidade: 'metro' },
            { codigo: 'ET-P8', nome: 'Entretela Pl√°stica 8cm', categoria: 'Entretela', preco: 1.26, unidade: 'metro' },
            { codigo: 'ET-T8', nome: 'Entretela TNT 8cm', categoria: 'Entretela', preco: 0.80, unidade: 'metro' },
            { codigo: 'ET-T10', nome: 'Entretela TNT 10cm', categoria: 'Entretela', preco: 1.00, unidade: 'metro' },
            { codigo: 'SL-45', nome: 'Suporte L 4x5', categoria: 'Suporte', preco: 5.70, unidade: 'unidade' },
            { codigo: 'SL-47', nome: 'Suporte L 4x7', categoria: 'Suporte', preco: 6.60, unidade: 'unidade' },
            { codigo: 'SL-410', nome: 'Suporte L 4x10', categoria: 'Suporte', preco: 7.30, unidade: 'unidade' },
            { codigo: 'TB-19M', nome: 'Tubo Metal 19mm', categoria: 'Var√£o', preco: 12.80, unidade: 'metro' },
            { codigo: 'TB-28M', nome: 'Tubo Metal 28mm', categoria: 'Var√£o', preco: 17.20, unidade: 'metro' },
            { codigo: 'TB-19P', nome: 'Tubo PVC 19mm', categoria: 'Var√£o', preco: 10.50, unidade: 'metro' },
            { codigo: 'TB-28P', nome: 'Tubo PVC 28mm', categoria: 'Var√£o', preco: 16.30, unidade: 'metro' },
            { codigo: 'TB-28W', nome: 'Tubo Wave 28mm', categoria: 'Var√£o', preco: 24.30, unidade: 'metro' },
            { codigo: 'PT-T19', nome: 'Ponteira Tampa 19mm', categoria: 'Ponteira', preco: 3.40, unidade: 'unidade' },
            { codigo: 'PT-T28', nome: 'Ponteira Tampa 28mm', categoria: 'Ponteira', preco: 4.30, unidade: 'unidade' },
            { codigo: 'PT-B19', nome: 'Ponteira Bola 19mm', categoria: 'Ponteira', preco: 4.90, unidade: 'unidade' },
            { codigo: 'PT-B28', nome: 'Ponteira Bola 28mm', categoria: 'Ponteira', preco: 5.95, unidade: 'unidade' },
            { codigo: 'SM-19-4', nome: 'Suporte Metal 19mm 4cm', categoria: 'Suporte', preco: 9.80, unidade: 'unidade' },
            { codigo: 'SM-28-4', nome: 'Suporte Metal 28mm 4cm', categoria: 'Suporte', preco: 10.20, unidade: 'unidade' },
            { codigo: 'SM-RF19', nome: 'Suporte Metal Refor√ßado 19mm', categoria: 'Suporte', preco: 14.75, unidade: 'unidade' },
            { codigo: 'SM-RF28', nome: 'Suporte Metal Refor√ßado 28mm', categoria: 'Suporte', preco: 16.80, unidade: 'unidade' },
            { codigo: 'FR-2', nome: 'Franzidor 2 Fios', categoria: 'Franzidor', preco: 0.87, unidade: 'metro' },
            { codigo: 'FR-4', nome: 'Franzidor 4 Fios', categoria: 'Franzidor', preco: 1.40, unidade: 'metro' },
            { codigo: 'FR-6', nome: 'Franzidor 6 Fios', categoria: 'Franzidor', preco: 2.05, unidade: 'metro' },
            { codigo: 'IL-28RB', nome: 'Ilh√≥s 28mm Redondo Branco', categoria: 'Ilh√≥s', preco: 0.39, unidade: 'unidade' },
            { codigo: 'IL-28RC', nome: 'Ilh√≥s 28mm Redondo Cromado', categoria: 'Ilh√≥s', preco: 0.72, unidade: 'unidade' },
            { codigo: 'AR-19B', nome: 'Argola 19mm Branca', categoria: 'Argola', preco: 0.22, unidade: 'unidade' },
            { codigo: 'AR-28B', nome: 'Argola 28mm Branca', categoria: 'Argola', preco: 0.34, unidade: 'unidade' },
            { codigo: 'AR-28C', nome: 'Argola 28mm Cromada', categoria: 'Argola', preco: 0.58, unidade: 'unidade' },
          ]
        };

        const formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        const formatPercent = (value) => `${value.toFixed(1)}%`;
        const gerarNumeroOrcamento = () => {
          const ano = new Date().getFullYear();
          const mes = String(new Date().getMonth() + 1).padStart(2, '0');
          const random = Math.floor(Math.random() * 9999).toString().padStart(4, '0');
          return `VD${ano}${mes}-${random}`;
        };

        // ==================== LOGIN ====================
        function LoginScreen({ onLogin }) {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');

          const handleLogin = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) { setError('Email ou senha inv√°lidos'); setLoading(false); }
            else { onLogin(data.user); }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
                <div className="text-center mb-8">
                  <h1 className="text-4xl font-serif text-slate-800 tracking-wide">Velluxe</h1>
                  <div className="flex justify-center gap-1 my-2">
                    <div className="w-8 h-1 bg-amber-500 rounded"></div>
                    <div className="w-8 h-1 bg-slate-800 rounded"></div>
                    <div className="w-8 h-1 bg-amber-300 rounded"></div>
                  </div>
                  <p className="text-sm font-serif italic text-gray-500">Decor</p>
                  <p className="text-xs text-gray-400 mt-4">Sistema de Or√ßamentos</p>
                </div>
                <form onSubmit={handleLogin} className="space-y-4">
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">E-mail</label>
                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="seu@email.com" required />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">Senha</label>
                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-amber-500 focus:border-transparent" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
                  </div>
                  {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg">{error}</div>}
                  <button type="submit" disabled={loading} className="w-full bg-amber-500 hover:bg-amber-600 text-white font-semibold py-3 rounded-lg transition-colors disabled:opacity-50">
                    {loading ? 'Entrando...' : 'Entrar'}
                  </button>
                </form>
                <p className="text-center text-xs text-gray-400 mt-6">Cortinas Sob Medida ‚Ä¢ Cascavel/PR</p>
              </div>
            </div>
          );
        }

        // ==================== APP PRINCIPAL ====================
        function VelluxeOrcamentos({ user, onLogout }) {
          const pdfRef = useRef(null);
          const [activeTab, setActiveTab] = useState('dashboard');
          const [showPreview, setShowPreview] = useState(false);
          const [searchTerm, setSearchTerm] = useState('');
          const [categoriaFiltro, setCategoriaFiltro] = useState('todos');
          const [showAddItem, setShowAddItem] = useState(false);
          const [itemSelecionado, setItemSelecionado] = useState(null);
          const [quantidade, setQuantidade] = useState(1);
          const [custoUnitario, setCustoUnitario] = useState(''); // MUDAN√áA: Estado para CUSTO
          const [descricaoItem, setDescricaoItem] = useState('');
          const [medidaLargura, setMedidaLargura] = useState('');
          const [medidaAltura, setMedidaAltura] = useState('');
          const [gerando, setGerando] = useState(false);
          const [salvando, setSalvando] = useState(false);
          const [carregando, setCarregando] = useState(true);
          const [editandoId, setEditandoId] = useState(null);

          const orcamentoVazio = {
            numero: gerarNumeroOrcamento(),
            data: new Date().toISOString().split('T')[0],
            validade: 15,
            status: 'rascunho',
            cliente: { nome: '', telefone: '', email: '', cpfCnpj: '', endereco: '', numero: '', complemento: '', bairro: '', cidade: '', estado: 'PR', cep: '' },
            itens: [],
            custoMaoObra: 0,
            custoInstalacao: 0,
            markup: 100,
            desconto: 0,
            formaPagamento: '√Ä vista ou em at√© 3x sem juros',
            prazoEntrega: '20 a 30 dias √∫teis',
            observacoes: '',
            garantia: '12 meses contra defeitos de fabrica√ß√£o'
          };

          const [orcamento, setOrcamento] = useState(orcamentoVazio);
          const [historico, setHistorico] = useState([]);
          const [viewMode, setViewMode] = useState('lista'); // 'lista' ou 'kanban'
          const [filtroStatus, setFiltroStatus] = useState('todos');
          const [filtroDataInicio, setFiltroDataInicio] = useState(() => {
            const d = new Date(); d.setDate(d.getDate() - 30); return d.toISOString().split('T')[0];
          });
          const [filtroDataFim, setFiltroDataFim] = useState(() => new Date().toISOString().split('T')[0]);
          const [buscaHistorico, setBuscaHistorico] = useState('');
          
          // Estados do m√≥dulo de Clientes
          const [clientes, setClientes] = useState([]);
          const [showClienteModal, setShowClienteModal] = useState(false);
          const [clienteEditando, setClienteEditando] = useState(null);
          const [buscaCliente, setBuscaCliente] = useState('');
          const [showSelecionarCliente, setShowSelecionarCliente] = useState(false);
          
          // Estados do m√≥dulo de Produtos/Fornecedores
          const [fornecedores, setFornecedores] = useState([]);
          const [produtosBanco, setProdutosBanco] = useState([]);
          const [showFornecedorModal, setShowFornecedorModal] = useState(false);
          const [showProdutoModal, setShowProdutoModal] = useState(false);
          const [showImportarPDF, setShowImportarPDF] = useState(false);
          const [fornecedorEditando, setFornecedorEditando] = useState(null);
          const [produtoEditando, setProdutoEditando] = useState(null);
          const [buscaProduto, setBuscaProduto] = useState('');
          const [filtroFornecedor, setFiltroFornecedor] = useState('todos');
          const [importandoPDF, setImportandoPDF] = useState(false);
          const [produtosImportados, setProdutosImportados] = useState([]);
          
          // Estados do m√≥dulo Financeiro
          const [transacoes, setTransacoes] = useState([]);
          const [contasPagar, setContasPagar] = useState([]);
          const [contasReceber, setContasReceber] = useState([]);
          const [categoriasFinanceiras, setCategoriasFinanceiras] = useState([]);
          const [showTransacaoModal, setShowTransacaoModal] = useState(false);
          const [showContaPagarModal, setShowContaPagarModal] = useState(false);
          const [showContaReceberModal, setShowContaReceberModal] = useState(false);
          const [transacaoEditando, setTransacaoEditando] = useState(null);
          const [contaPagarEditando, setContaPagarEditando] = useState(null);
          const [contaReceberEditando, setContaReceberEditando] = useState(null);
          const [periodoFinanceiro, setPeriodoFinanceiro] = useState('mes'); // mes, trimestre, ano
          const [mesRelatorio, setMesRelatorio] = useState(new Date().toISOString().slice(0, 7));

          useEffect(() => { carregarHistorico(); carregarClientes(); carregarFornecedores(); carregarProdutos(); carregarDadosFinanceiros(); }, []);
          
          const carregarClientes = async () => {
            const { data, error } = await supabase.from('clientes').select('*').order('nome', { ascending: true });
            if (data) setClientes(data);
          };
          
          const carregarFornecedores = async () => {
            const { data, error } = await supabase.from('fornecedores').select('*').order('nome', { ascending: true });
            if (data) setFornecedores(data);
          };
          
          const carregarProdutos = async () => {
            const { data, error } = await supabase.from('produtos').select('*, fornecedores(nome)').order('nome', { ascending: true });
            if (data) setProdutosBanco(data);
          };
          
          const salvarFornecedor = async (fornecedorData) => {
            if (fornecedorEditando) {
              const { error } = await supabase.from('fornecedores').update(fornecedorData).eq('id', fornecedorEditando.id);
              if (!error) { await carregarFornecedores(); setShowFornecedorModal(false); setFornecedorEditando(null); }
            } else {
              const { error } = await supabase.from('fornecedores').insert([{ ...fornecedorData, user_id: user.id }]);
              if (!error) { await carregarFornecedores(); setShowFornecedorModal(false); }
            }
          };
          
          const excluirFornecedor = async (id) => {
            if (confirm('Excluir fornecedor? Produtos vinculados ficar√£o sem fornecedor.')) {
              await supabase.from('fornecedores').delete().eq('id', id);
              await carregarFornecedores();
            }
          };
          
          const salvarProduto = async (produtoData) => {
            if (produtoEditando) {
              const { error } = await supabase.from('produtos').update(produtoData).eq('id', produtoEditando.id);
              if (!error) { await carregarProdutos(); setShowProdutoModal(false); setProdutoEditando(null); }
            } else {
              const { error } = await supabase.from('produtos').insert([{ ...produtoData, user_id: user.id }]);
              if (!error) { await carregarProdutos(); setShowProdutoModal(false); }
            }
          };
          
          const excluirProduto = async (id) => {
            if (confirm('Excluir este produto?')) {
              await supabase.from('produtos').delete().eq('id', id);
              await carregarProdutos();
            }
          };
          
          // Parser para PDFs da S√≥ S√≥ Decor
          const parsearPDFSoSo = (texto, tipo) => {
            const produtos = [];
            const linhas = texto.split('\n').filter(l => l.trim());
            
            if (tipo === 'tecidos') {
              linhas.forEach(linha => {
                let match = null;
                let codigo, nome, largura, preco;
                
                // Formato 1: C√ìDIGO NOME LARGURA PRE√áO R$ (R$ no final)
                // Ex: 11317 VOIL LISO BRANCO 3,00 11,60 R$
                const regex1 = /^(\d+(?:-\d+)?)\s+(.+?)\s+(\d[,\.]\d+)\s+([\d\.]+[,][\d]+)\s*R\s*\$\s*$/i;
                match = linha.match(regex1);
                if (match) {
                  codigo = match[1].trim();
                  nome = match[2].trim();
                  largura = parseFloat(match[3].replace(',', '.'));
                  preco = parseFloat(match[4].replace('.', '').replace(',', '.'));
                }
                
                // Formato 2: C√ìDIGO NOME LARGURA R$ PRE√áO (R$ antes do pre√ßo)
                // Ex: 1157-01 LINEN LOOK ESPECIAL BRANCO 2,80 R$ 24,90
                if (!match) {
                  const regex2 = /^(\d+(?:-\d+)?)\s+(.+?)\s+(\d[,\.]\d+)\s*R\s*\$\s*([\d\.]+[,][\d]+)\s*$/i;
                  match = linha.match(regex2);
                  if (match) {
                    codigo = match[1].trim();
                    nome = match[2].trim();
                    largura = parseFloat(match[3].replace(',', '.'));
                    preco = parseFloat(match[4].replace('.', '').replace(',', '.'));
                  }
                }
                
                if (match && codigo && nome && preco) {
                  produtos.push({
                    codigo: codigo,
                    nome: nome,
                    largura: largura,
                    preco: preco,
                    unidade: 'metro',
                    categoria: 'Tecido'
                  });
                }
              });
            } else if (tipo === 'aviamentos') {
              // Aviamentos: DESCRI√á√ÉO PRE√áO R$ ou DESCRI√á√ÉO R$ PRE√áO ou DESCRI√á√ÉO PRE√áO (sem R$)
              // Ex: ARGOLA 19MM PVC BRANCA / IMBUIA / PALHA 0,22 R$
              // Ex: ARGOLA 19MM PVC A√áO ESCOVADO 1,34
              linhas.forEach(linha => {
                let nome = null;
                let preco = null;
                
                // Formato 1: DESCRI√á√ÉO PRE√áO R$ (R$ no final)
                let match = linha.match(/^(.+?)\s+([\d\.]+[,][\d]+)\s*R\s*\$\s*$/i);
                if (match) {
                  nome = match[1].trim();
                  preco = parseFloat(match[2].replace('.', '').replace(',', '.'));
                }
                
                // Formato 2: DESCRI√á√ÉO R$ PRE√áO (R$ antes do pre√ßo)
                if (!match) {
                  match = linha.match(/^(.+?)\s*R\s*\$\s*([\d\.]+[,][\d]+)\s*$/i);
                  if (match) {
                    nome = match[1].trim();
                    preco = parseFloat(match[2].replace('.', '').replace(',', '.'));
                  }
                }
                
                // Formato 3: DESCRI√á√ÉO PRE√áO (sem R$, s√≥ n√∫mero no final)
                // Ex: ARGOLA 19MM PVC A√áO ESCOVADO 1,34
                if (!match) {
                  match = linha.match(/^(.+?)\s+([\d]+[,][\d]+)\s*$/i);
                  if (match) {
                    nome = match[1].trim();
                    preco = parseFloat(match[2].replace('.', '').replace(',', '.'));
                  }
                }
                
                // Valida e adiciona
                if (nome && preco && !linha.toUpperCase().includes('DESCRI√á√ÉO') && !linha.toUpperCase().includes('VALOR') && nome.length > 3) {
                  // Gera c√≥digo autom√°tico baseado no nome (primeiros 15 chars, sem espa√ßos)
                  const codigoAuto = 'AV-' + nome.substring(0, 15).replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                  produtos.push({
                    codigo: codigoAuto,
                    nome: nome,
                    largura: null,
                    preco: preco,
                    unidade: 'un',
                    categoria: 'Aviamento'
                  });
                }
              });
            } else if (tipo === 'persianas') {
              // Persianas: NOME R$ PRE√áO_VISTA R$ PRE√áO_CARTAO m¬≤
              // Ex: Vertical - Fluence (linha sem desconto) Consultar Disponibilidade. R$ 65,90 R$ 73,22 m¬≤
              // Pega o SEGUNDO pre√ßo (cart√£o 5x)
              linhas.forEach(linha => {
                // Regex: captura nome, depois dois valores R$ X,XX e termina com m¬≤ ou m2
                const match = linha.match(/^(.+?)\s+R\s*\$\s*([\d\.]+[,][\d]+)\s+R\s*\$\s*([\d\.]+[,][\d]+)\s*m[¬≤2]\s*$/i);
                if (match) {
                  let nome = match[1].trim();
                  // Remove textos desnecess√°rios
                  nome = nome.replace(/Consultar Disponibilidade\.?/gi, '').trim();
                  nome = nome.replace(/\s+/g, ' ').trim();
                  
                  const precoCartao = parseFloat(match[3].replace('.', '').replace(',', '.'));
                  
                  if (nome.length > 3 && precoCartao > 0) {
                    // Gera c√≥digo baseado no nome
                    const codigoAuto = 'P-' + nome.substring(0, 15).replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                    produtos.push({
                      codigo: codigoAuto,
                      nome: nome,
                      largura: null,
                      preco: precoCartao,
                      unidade: 'm2',
                      categoria: 'Persiana'
                    });
                  }
                }
              });
            }
            return produtos;
          };
          
          const importarProdutosPDF = async (produtosParaImportar, fornecedorId) => {
            setImportandoPDF(true);
            let importados = 0;
            let atualizados = 0;
            let erros = 0;
            
            for (const prod of produtosParaImportar) {
              try {
                // Verifica se produto j√° existe pelo c√≥digo
                const { data: existente } = await supabase.from('produtos').select('id').eq('codigo', prod.codigo).single();
                
                // Monta objeto limpo para o banco (sem campos extras)
                const produtoData = {
                  codigo: prod.codigo,
                  nome: prod.nome,
                  categoria: prod.categoria || 'Tecido',
                  largura: prod.largura || null,
                  preco: prod.preco || 0,
                  unidade: prod.unidade || 'metro',
                  fornecedor_id: fornecedorId,
                  user_id: user.id
                };
                
                if (existente) {
                  const { error } = await supabase.from('produtos').update(produtoData).eq('id', existente.id);
                  if (error) { console.error('Erro update:', error); erros++; }
                  else { atualizados++; }
                } else {
                  const { error } = await supabase.from('produtos').insert([produtoData]);
                  if (error) { console.error('Erro insert:', error); erros++; }
                  else { importados++; }
                }
              } catch (err) {
                console.error('Erro ao processar produto:', prod.codigo, err);
                erros++;
              }
            }
            
            await carregarProdutos();
            setImportandoPDF(false);
            setProdutosImportados([]);
            setShowImportarPDF(false);
            
            if (erros > 0) {
              alert(`‚ö†Ô∏è Importa√ß√£o conclu√≠da com erros!\n\n${importados} produtos novos\n${atualizados} atualizados\n${erros} erros (veja console)`);
            } else {
              alert(`‚úÖ Importa√ß√£o conclu√≠da!\n\n${importados} produtos novos\n${atualizados} produtos atualizados`);
            }
          };
          
          // ========== FUN√á√ïES FINANCEIRAS ==========
          const carregarDadosFinanceiros = async () => {
            const [trans, pagar, receber, cats] = await Promise.all([
              supabase.from('transacoes').select('*, categorias_financeiras(nome, cor)').order('data_transacao', { ascending: false }),
              supabase.from('contas_pagar').select('*, categorias_financeiras(nome, cor), fornecedores(nome)').order('data_vencimento', { ascending: true }),
              supabase.from('contas_receber').select('*, categorias_financeiras(nome, cor), clientes(nome)').order('data_vencimento', { ascending: true }),
              supabase.from('categorias_financeiras').select('*').order('nome')
            ]);
            if (trans.data) setTransacoes(trans.data);
            if (pagar.data) setContasPagar(pagar.data);
            if (receber.data) setContasReceber(receber.data);
            if (cats.data) setCategoriasFinanceiras(cats.data);
          };
          
          const salvarTransacao = async (dados) => {
            if (transacaoEditando) {
              const { error } = await supabase.from('transacoes').update(dados).eq('id', transacaoEditando.id);
              if (!error) { await carregarDadosFinanceiros(); setShowTransacaoModal(false); setTransacaoEditando(null); }
            } else {
              const { error } = await supabase.from('transacoes').insert([{ ...dados, user_id: user.id }]);
              if (!error) { await carregarDadosFinanceiros(); setShowTransacaoModal(false); }
            }
          };
          
          const excluirTransacao = async (id) => {
            if (confirm('Excluir esta transa√ß√£o?')) {
              await supabase.from('transacoes').delete().eq('id', id);
              await carregarDadosFinanceiros();
            }
          };
          
          const salvarContaPagar = async (dados) => {
            if (contaPagarEditando) {
              const { error } = await supabase.from('contas_pagar').update(dados).eq('id', contaPagarEditando.id);
              if (!error) { await carregarDadosFinanceiros(); setShowContaPagarModal(false); setContaPagarEditando(null); }
            } else {
              const { error } = await supabase.from('contas_pagar').insert([{ ...dados, user_id: user.id }]);
              if (!error) { await carregarDadosFinanceiros(); setShowContaPagarModal(false); }
            }
          };
          
          const pagarConta = async (conta) => {
            const { error } = await supabase.from('contas_pagar').update({ 
              status: 'pago', 
              data_pagamento: new Date().toISOString().split('T')[0] 
            }).eq('id', conta.id);
            if (!error) {
              // Cria transa√ß√£o de despesa
              await supabase.from('transacoes').insert([{
                user_id: user.id,
                tipo: 'despesa',
                categoria_id: conta.categoria_id,
                descricao: conta.descricao,
                valor: conta.valor,
                data_transacao: new Date().toISOString().split('T')[0],
                data_pagamento: new Date().toISOString().split('T')[0],
                status: 'pago',
                fornecedor_id: conta.fornecedor_id
              }]);
              await carregarDadosFinanceiros();
            }
          };
          
          const excluirContaPagar = async (id) => {
            if (confirm('Excluir esta conta?')) {
              await supabase.from('contas_pagar').delete().eq('id', id);
              await carregarDadosFinanceiros();
            }
          };
          
          const salvarContaReceber = async (dados) => {
            if (contaReceberEditando) {
              const { error } = await supabase.from('contas_receber').update(dados).eq('id', contaReceberEditando.id);
              if (!error) { await carregarDadosFinanceiros(); setShowContaReceberModal(false); setContaReceberEditando(null); }
            } else {
              const { error } = await supabase.from('contas_receber').insert([{ ...dados, user_id: user.id }]);
              if (!error) { await carregarDadosFinanceiros(); setShowContaReceberModal(false); }
            }
          };
          
          const receberConta = async (conta) => {
            const { error } = await supabase.from('contas_receber').update({ 
              status: 'recebido', 
              data_recebimento: new Date().toISOString().split('T')[0] 
            }).eq('id', conta.id);
            if (!error) {
              // Cria transa√ß√£o de receita
              await supabase.from('transacoes').insert([{
                user_id: user.id,
                tipo: 'receita',
                categoria_id: conta.categoria_id,
                descricao: conta.descricao,
                valor: conta.valor,
                data_transacao: new Date().toISOString().split('T')[0],
                data_pagamento: new Date().toISOString().split('T')[0],
                status: 'pago',
                cliente_id: conta.cliente_id,
                orcamento_id: conta.orcamento_id
              }]);
              await carregarDadosFinanceiros();
            }
          };
          
          const excluirContaReceber = async (id) => {
            if (confirm('Excluir esta conta?')) {
              await supabase.from('contas_receber').delete().eq('id', id);
              await carregarDadosFinanceiros();
            }
          };
          
          // M√©tricas calculadas
          const calcularMetricas = () => {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            // Or√ßamentos
            const orcamentosMes = historico.filter(o => new Date(o.created_at) >= inicioMes && new Date(o.created_at) <= fimMes);
            const orcamentosAprovados = historico.filter(o => ['aprovado', 'producao', 'pronto', 'entregue', 'fechado'].includes(o.status));
            const orcamentosAprovadosMes = orcamentosMes.filter(o => ['aprovado', 'producao', 'pronto', 'entregue', 'fechado'].includes(o.status));
            
            const totalOrcamentos = historico.length;
            const totalAprovados = orcamentosAprovados.length;
            const taxaConversao = totalOrcamentos > 0 ? (totalAprovados / totalOrcamentos * 100).toFixed(1) : 0;
            
            const valorTotalOrcamentos = historico.reduce((acc, o) => acc + (o.totais?.total || 0), 0);
            const valorAprovado = orcamentosAprovados.reduce((acc, o) => acc + (o.totais?.total || 0), 0);
            const valorAprovadoMes = orcamentosAprovadosMes.reduce((acc, o) => acc + (o.totais?.total || 0), 0);
            
            // Financeiro
            const receitasMes = transacoes.filter(t => t.tipo === 'receita' && new Date(t.data_transacao) >= inicioMes && new Date(t.data_transacao) <= fimMes);
            const despesasMes = transacoes.filter(t => t.tipo === 'despesa' && new Date(t.data_transacao) >= inicioMes && new Date(t.data_transacao) <= fimMes);
            const totalReceitasMes = receitasMes.reduce((acc, t) => acc + parseFloat(t.valor), 0);
            const totalDespesasMes = despesasMes.reduce((acc, t) => acc + parseFloat(t.valor), 0);
            const saldoMes = totalReceitasMes - totalDespesasMes;
            
            // Contas
            const contasPagarPendentes = contasPagar.filter(c => c.status === 'pendente');
            const contasReceberPendentes = contasReceber.filter(c => c.status === 'pendente');
            const totalAPagar = contasPagarPendentes.reduce((acc, c) => acc + parseFloat(c.valor), 0);
            const totalAReceber = contasReceberPendentes.reduce((acc, c) => acc + parseFloat(c.valor), 0);
            
            // Vencidas
            const contasVencidas = contasPagar.filter(c => c.status === 'pendente' && new Date(c.data_vencimento) < hoje);
            const recebiveisVencidos = contasReceber.filter(c => c.status === 'pendente' && new Date(c.data_vencimento) < hoje);
            
            // Pr√≥ximos 7 dias
            const proximos7dias = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);
            const contasProximas = contasPagar.filter(c => c.status === 'pendente' && new Date(c.data_vencimento) <= proximos7dias && new Date(c.data_vencimento) >= hoje);
            const recebiveisProximos = contasReceber.filter(c => c.status === 'pendente' && new Date(c.data_vencimento) <= proximos7dias && new Date(c.data_vencimento) >= hoje);
            
            return {
              totalOrcamentos, totalAprovados, taxaConversao, valorTotalOrcamentos, valorAprovado, valorAprovadoMes,
              orcamentosMes: orcamentosMes.length,
              totalReceitasMes, totalDespesasMes, saldoMes,
              totalAPagar, totalAReceber,
              contasVencidas: contasVencidas.length,
              recebiveisVencidos: recebiveisVencidos.length,
              contasProximas: contasProximas.length,
              recebiveisProximos: recebiveisProximos.length,
              saldoProjetado: totalAReceber - totalAPagar
            };
          };
          
          const metricas = calcularMetricas();
          
          const salvarCliente = async (clienteData) => {
            if (clienteEditando) {
              const { error } = await supabase.from('clientes').update(clienteData).eq('id', clienteEditando.id);
              if (!error) { await carregarClientes(); setShowClienteModal(false); setClienteEditando(null); }
            } else {
              const { error } = await supabase.from('clientes').insert([{ ...clienteData, user_id: user.id }]);
              if (!error) { await carregarClientes(); setShowClienteModal(false); }
            }
          };
          
          const excluirCliente = async (id) => {
            if (confirm('Excluir este cliente?')) {
              await supabase.from('clientes').delete().eq('id', id);
              await carregarClientes();
            }
          };
          
          // Auto-cadastrar ou atualizar cliente ao salvar or√ßamento
          const salvarOuAtualizarCliente = async (clienteOrcamento) => {
            if (!clienteOrcamento.nome || clienteOrcamento.nome.trim() === '') return;
            
            const clienteData = {
              nome: clienteOrcamento.nome,
              telefone: clienteOrcamento.telefone || null,
              email: clienteOrcamento.email || null,
              cpf_cnpj: clienteOrcamento.cpfCnpj || null,
              endereco: clienteOrcamento.endereco || null,
              numero: clienteOrcamento.numero || null,
              complemento: clienteOrcamento.complemento || null,
              bairro: clienteOrcamento.bairro || null,
              cidade: clienteOrcamento.cidade || null,
              estado: clienteOrcamento.estado || 'PR',
              cep: clienteOrcamento.cep || null
            };
            
            // Busca cliente existente por telefone ou CPF/CNPJ
            let clienteExistente = null;
            
            if (clienteOrcamento.cpfCnpj) {
              const { data } = await supabase.from('clientes').select('id').eq('cpf_cnpj', clienteOrcamento.cpfCnpj).single();
              if (data) clienteExistente = data;
            }
            
            if (!clienteExistente && clienteOrcamento.telefone) {
              const { data } = await supabase.from('clientes').select('id').eq('telefone', clienteOrcamento.telefone).single();
              if (data) clienteExistente = data;
            }
            
            if (clienteExistente) {
              // Atualiza cliente existente
              await supabase.from('clientes').update(clienteData).eq('id', clienteExistente.id);
            } else {
              // Cria novo cliente
              await supabase.from('clientes').insert([{ ...clienteData, user_id: user.id }]);
            }
            
            // Recarrega lista de clientes
            await carregarClientes();
          };
          
          const selecionarCliente = (cliente) => {
            setOrcamento({
              ...orcamento,
              cliente: {
                nome: cliente.nome,
                telefone: cliente.telefone || '',
                email: cliente.email || '',
                cpfCnpj: cliente.cpf_cnpj || '',
                endereco: cliente.endereco || '',
                numero: cliente.numero || '',
                complemento: cliente.complemento || '',
                bairro: cliente.bairro || '',
                cidade: cliente.cidade || '',
                estado: cliente.estado || 'PR',
                cep: cliente.cep || ''
              }
            });
            setShowSelecionarCliente(false);
          };

          const carregarHistorico = async () => {
            setCarregando(true);
            const { data, error } = await supabase.from('orcamentos').select('*').order('created_at', { ascending: false });
            if (error) { console.error('Erro:', error); }
            if (data) {
              setHistorico(data.map(orc => ({
                id: orc.id, numero: orc.numero, data: orc.data, validade: orc.validade,
                status: orc.status || 'rascunho',
                cliente: orc.cliente, itens: orc.itens,
                custoMaoObra: parseFloat(orc.custo_mao_obra) || 0,
                custoInstalacao: parseFloat(orc.custo_instalacao) || 0,
                markup: parseFloat(orc.markup) || 100,
                desconto: parseFloat(orc.desconto) || 0,
                formaPagamento: orc.forma_pagamento, prazoEntrega: orc.prazo_entrega,
                observacoes: orc.observacoes, garantia: orc.garantia, totais: orc.totais,
                dataSalvo: orc.created_at, userEmail: orc.user_email
              })));
            }
            setCarregando(false);
          };

          // Usa apenas produtos do banco de dados
          const todosProdutos = React.useMemo(() => {
            return produtosBanco.map(p => ({
              codigo: p.codigo,
              nome: p.nome,
              categoria: p.categoria || 'Sem categoria',
              largura: p.largura || 1,
              preco: p.preco,
              unidade: p.unidade || 'metro',
              fornecedor: p.fornecedores?.nome || null,
              doBanco: true,
              id: p.id
            }));
          }, [produtosBanco]);
          
          const categorias = [...new Set(todosProdutos.map(p => p.categoria))].sort();
          const produtosFiltrados = todosProdutos.filter(p => {
            const matchSearch = p.nome.toLowerCase().includes(searchTerm.toLowerCase()) || p.codigo.toLowerCase().includes(searchTerm.toLowerCase());
            const matchCategoria = categoriaFiltro === 'todos' || p.categoria === categoriaFiltro;
            return matchSearch && matchCategoria;
          });

          // ========== L√ìGICA DE TOTAIS (Markup APENAS nos Itens) ==========
          const calcularTotais = () => {
            const custoMateriais = orcamento.itens.reduce((acc, item) => acc + ((item.precoCusto || 0) * item.quantidade), 0);
            const custoServicos = orcamento.custoMaoObra + orcamento.custoInstalacao;
            const custoTotal = custoMateriais + custoServicos;
            
            // Markup APENAS nos materiais/itens
            const vendaMateriais = custoMateriais * (1 + orcamento.markup / 100);
            // Servi√ßos entram direto (sem markup)
            const precoVendaBruto = vendaMateriais + custoServicos;
            
            // Desconto aplicado no total
            const valorDesconto = precoVendaBruto * (orcamento.desconto / 100);
            const total = precoVendaBruto - valorDesconto;
            
            const lucro = total - custoTotal;
            const margem = total > 0 ? (lucro / total) * 100 : 0;
            
            return { custoMateriais, custoServicos, vendaMateriais, custoTotal, precoVendaBruto, valorDesconto, total, lucro, margem };
          };
          const totais = calcularTotais();

          const adicionarItem = () => {
            if (!itemSelecionado || quantidade <= 0) return;
            const custoFinal = parseFloat(custoUnitario) || itemSelecionado.preco;
            
            // Calcula quantidade baseado nas medidas
            let qtdFinal = parseFloat(quantidade);
            let descMedidas = '';
            
            // Se tem largura e altura, calcula m¬≤
            if (medidaLargura && medidaAltura) {
              const larg = parseFloat(medidaLargura);
              const alt = parseFloat(medidaAltura);
              qtdFinal = larg * alt; // m¬≤
              descMedidas = ` (${larg}m x ${alt}m)`;
            }
            
            const novoItem = {
              id: Date.now(), 
              codigo: itemSelecionado.codigo, 
              nome: itemSelecionado.nome,
              descricao: (descricaoItem || itemSelecionado.nome) + descMedidas, 
              categoria: itemSelecionado.categoria,
              quantidade: qtdFinal, 
              unidade: 'm2',
              medidaLargura: medidaLargura ? parseFloat(medidaLargura) : null,
              medidaAltura: medidaAltura ? parseFloat(medidaAltura) : null,
              precoCusto: custoFinal,
              valorUnitario: custoFinal,
              valorTotal: custoFinal * qtdFinal
            };
            setOrcamento({ ...orcamento, itens: [...orcamento.itens, novoItem] });
            setShowAddItem(false); setItemSelecionado(null); setQuantidade(1); setCustoUnitario(''); setDescricaoItem(''); setMedidaLargura(''); setMedidaAltura('');
          };

          const removerItem = (itemId) => setOrcamento({ ...orcamento, itens: orcamento.itens.filter(i => i.id !== itemId) });
          const atualizarCliente = (campo, valor) => setOrcamento({ ...orcamento, cliente: { ...orcamento.cliente, [campo]: valor } });

          // CORRE√á√ÉO CR√çTICA DO PDF NO IPHONE
          const gerarPDF = async () => {
            setGerando(true);
            const opt = {
              margin: [0, 0, 0, 0], // Margem Zero Explicita
              filename: `Orcamento_${orcamento.numero}_${orcamento.cliente.nome.replace(/\s+/g, '_') || 'Cliente'}.pdf`,
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { 
                scale: 2, 
                useCORS: true, 
                scrollY: 0,
                scrollX: 0,
                // ESSAS DUAS LINHAS S√ÉO CRUCIAIS PARA IOS
                windowWidth: document.documentElement.offsetWidth,
                windowHeight: document.documentElement.offsetHeight
              }, 
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            try { await html2pdf().set(opt).from(pdfRef.current).save(); }
            catch (e) { alert('Erro ao gerar PDF'); }
            setGerando(false);
          };

          const salvarOrcamento = async () => {
            if (!orcamento.cliente.nome) { alert('Preencha o nome do cliente'); return; }
            if (orcamento.itens.length === 0) { alert('Adicione pelo menos um item'); return; }
            setSalvando(true);
            const dados = {
              user_id: user.id, user_email: user.email, numero: orcamento.numero, data: orcamento.data,
              validade: orcamento.validade, status: orcamento.status || 'rascunho',
              cliente: orcamento.cliente, itens: orcamento.itens,
              custo_mao_obra: orcamento.custoMaoObra, custo_instalacao: orcamento.custoInstalacao,
              markup: orcamento.markup, desconto: orcamento.desconto, forma_pagamento: orcamento.formaPagamento,
              prazo_entrega: orcamento.prazoEntrega, observacoes: orcamento.observacoes,
              garantia: orcamento.garantia, totais: calcularTotais()
            };
            let result;
            if (editandoId) { result = await supabase.from('orcamentos').update(dados).eq('id', editandoId); }
            else { result = await supabase.from('orcamentos').insert([dados]); }
            if (result.error) { alert('Erro: ' + result.error.message); }
            else { 
              // Auto-cadastra ou atualiza o cliente
              await salvarOuAtualizarCliente(orcamento.cliente);
              alert(editandoId ? 'Atualizado!' : 'Salvo!'); 
              setEditandoId(null); 
              await carregarHistorico(); 
            }
            setSalvando(false);
          };

          const novoOrcamento = () => {
            if (orcamento.itens.length > 0 && !confirm('Criar novo? Dados atuais ser√£o perdidos.')) return;
            setOrcamento({ ...orcamentoVazio, numero: gerarNumeroOrcamento() }); setEditandoId(null);
          };
          const limparOrcamento = () => { if (confirm('Limpar dados?')) setOrcamento({ ...orcamentoVazio, numero: orcamento.numero }); };
          const editarOrcamento = (orc) => { setOrcamento({ ...orc, status: orc.status || 'rascunho', itens: orc.itens.map(i => ({ ...i, id: Date.now() + Math.random() })) }); setEditandoId(orc.id); setActiveTab('orcamento'); };
          const duplicarOrcamento = (orc) => { setOrcamento({ ...orc, numero: gerarNumeroOrcamento(), data: new Date().toISOString().split('T')[0], status: 'rascunho', itens: orc.itens.map(i => ({ ...i, id: Date.now() + Math.random() })) }); setEditandoId(null); setActiveTab('orcamento'); };
          const excluirOrcamento = async (id) => { if (confirm('Excluir permanentemente?')) { await supabase.from('orcamentos').delete().eq('id', id); await carregarHistorico(); } };

          const mudarStatus = async (id, novoStatus) => {
            const { error } = await supabase.from('orcamentos').update({ status: novoStatus }).eq('id', id);
            if (error) { alert('Erro ao atualizar status'); }
            else { await carregarHistorico(); }
          };

          // === FUN√á√ÉO HELPER PARA C√ÅLCULO DE ITEM NA TELA E PDF ===
          const calcularPrecoFinalItem = (item) => {
             const itemMaterialCost = item.precoCusto * item.quantidade;
             const totalMaterialCost = orcamento.itens.reduce((acc, curr) => acc + (curr.precoCusto * curr.quantidade), 0);
             const totalServiceCost = orcamento.custoMaoObra + orcamento.custoInstalacao;
             
             // Servi√ßo distribu√≠do proporcionalmente (SEM markup)
             const serviceShare = totalMaterialCost > 0 
               ? (itemMaterialCost / totalMaterialCost) * totalServiceCost 
               : 0;

             // Markup APENAS no material do item
             const itemVenda = itemMaterialCost * (1 + orcamento.markup / 100);
             
             // Total = material com markup + servi√ßo sem markup - desconto
             return (itemVenda + serviceShare) * (1 - orcamento.desconto / 100);
          };

          return (
            <div className="min-h-screen bg-gray-100">
              {/* Header */}
              <header className="bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-lg">
                <div className="max-w-6xl mx-auto px-4 py-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-4">
                      <div>
                        <h1 className="text-2xl font-serif tracking-wide">Velluxe</h1>
                        <div className="flex gap-1 my-1"><div className="w-6 h-0.5 bg-amber-500"></div><div className="w-6 h-0.5 bg-white"></div><div className="w-6 h-0.5 bg-amber-300"></div></div>
                        <p className="text-xs text-gray-400 italic">Decor</p>
                      </div>
                      <div className="hidden sm:block border-l border-gray-600 pl-4 ml-2">
                        <p className="text-amber-400 font-medium">Sistema de Or√ßamentos</p>
                        <p className="text-xs text-gray-400">Cascavel/PR</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="text-right hidden sm:block"><p className="text-xs text-gray-400">Logado</p><p className="text-sm text-amber-400">{user.email}</p></div>
                      <button onClick={novoOrcamento} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium">+ Novo</button>
                      <button onClick={onLogout} className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-lg text-sm" title="Sair">üö™</button>
                    </div>
                  </div>
                </div>
              </header>

              {/* Tabs */}
              <nav className="bg-white border-b shadow-sm sticky top-0 z-40">
                <div className="max-w-6xl mx-auto flex overflow-x-auto">
                  {[
                    { id: 'dashboard', label: 'üìä Dashboard' },
                    { id: 'orcamento', label: 'üìù Or√ßamento', badge: orcamento.itens.length }, 
                    { id: 'catalogo', label: 'üì¶ Produtos' },
                    { id: 'clientes', label: 'üë• Clientes', badge: clientes.length },
                    { id: 'financeiro', label: 'üí∞ Financeiro' },
                    { id: 'relatorios', label: 'üìà Relat√≥rios' },
                    { id: 'historico', label: 'üìÅ Pedidos', badge: historico.length }
                  ].map(tab => (
                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-3 text-sm font-medium flex items-center gap-2 whitespace-nowrap ${activeTab === tab.id ? 'text-amber-600 border-b-2 border-amber-500 bg-amber-50' : 'text-gray-600 hover:bg-gray-50'}`}>
                      {tab.label}{tab.badge > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full ${activeTab === tab.id ? 'bg-amber-500 text-white' : 'bg-gray-200'}`}>{tab.badge}</span>}
                    </button>
                  ))}
                </div>
              </nav>

              {editandoId && <div className="bg-blue-500 text-white text-center py-2 text-sm">‚úèÔ∏è Editando <strong>{orcamento.numero}</strong></div>}

              <main className="max-w-6xl mx-auto p-4">
                {/* TAB DASHBOARD */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-4">
                    {/* Cards de M√©tricas Principais */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-4 text-white">
                        <p className="text-blue-100 text-xs uppercase">Or√ßamentos (Total)</p>
                        <p className="text-3xl font-bold">{metricas.totalOrcamentos}</p>
                        <p className="text-blue-200 text-xs mt-1">{metricas.orcamentosMes} este m√™s</p>
                      </div>
                      <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                        <p className="text-green-100 text-xs uppercase">Aprovados</p>
                        <p className="text-3xl font-bold">{metricas.totalAprovados}</p>
                        <p className="text-green-200 text-xs mt-1">{metricas.taxaConversao}% convers√£o</p>
                      </div>
                      <div className="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 text-white">
                        <p className="text-amber-100 text-xs uppercase">Valor Aprovado</p>
                        <p className="text-2xl font-bold">{formatCurrency(metricas.valorAprovado)}</p>
                        <p className="text-amber-200 text-xs mt-1">{formatCurrency(metricas.valorAprovadoMes)} este m√™s</p>
                      </div>
                      <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                        <p className="text-purple-100 text-xs uppercase">Saldo do M√™s</p>
                        <p className={`text-2xl font-bold ${metricas.saldoMes >= 0 ? 'text-white' : 'text-red-200'}`}>{formatCurrency(metricas.saldoMes)}</p>
                        <p className="text-purple-200 text-xs mt-1">Receitas - Despesas</p>
                      </div>
                    </div>
                    
                    {/* Resumo Financeiro */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {/* Receitas vs Despesas do M√™s */}
                      <div className="bg-white rounded-xl shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3">üìä Fluxo do M√™s</h3>
                        <div className="space-y-3">
                          <div>
                            <div className="flex justify-between text-sm mb-1">
                              <span className="text-gray-600">Receitas</span>
                              <span className="text-green-600 font-medium">{formatCurrency(metricas.totalReceitasMes)}</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div className="bg-green-500 h-2 rounded-full" style={{width: `${Math.min(100, metricas.totalReceitasMes / Math.max(metricas.totalReceitasMes, metricas.totalDespesasMes, 1) * 100)}%`}}></div>
                            </div>
                          </div>
                          <div>
                            <div className="flex justify-between text-sm mb-1">
                              <span className="text-gray-600">Despesas</span>
                              <span className="text-red-600 font-medium">{formatCurrency(metricas.totalDespesasMes)}</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                              <div className="bg-red-500 h-2 rounded-full" style={{width: `${Math.min(100, metricas.totalDespesasMes / Math.max(metricas.totalReceitasMes, metricas.totalDespesasMes, 1) * 100)}%`}}></div>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {/* A Receber */}
                      <div className="bg-white rounded-xl shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3">üíµ A Receber</h3>
                        <p className="text-3xl font-bold text-green-600">{formatCurrency(metricas.totalAReceber)}</p>
                        <div className="mt-3 space-y-1 text-sm">
                          {metricas.recebiveisVencidos > 0 && (
                            <p className="text-red-500">‚ö†Ô∏è {metricas.recebiveisVencidos} vencido(s)</p>
                          )}
                          {metricas.recebiveisProximos > 0 && (
                            <p className="text-amber-500">üìÖ {metricas.recebiveisProximos} pr√≥x. 7 dias</p>
                          )}
                          {metricas.recebiveisVencidos === 0 && metricas.recebiveisProximos === 0 && (
                            <p className="text-gray-400">Nenhum pendente</p>
                          )}
                        </div>
                      </div>
                      
                      {/* A Pagar */}
                      <div className="bg-white rounded-xl shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3">üí∏ A Pagar</h3>
                        <p className="text-3xl font-bold text-red-600">{formatCurrency(metricas.totalAPagar)}</p>
                        <div className="mt-3 space-y-1 text-sm">
                          {metricas.contasVencidas > 0 && (
                            <p className="text-red-500">‚ö†Ô∏è {metricas.contasVencidas} vencida(s)</p>
                          )}
                          {metricas.contasProximas > 0 && (
                            <p className="text-amber-500">üìÖ {metricas.contasProximas} pr√≥x. 7 dias</p>
                          )}
                          {metricas.contasVencidas === 0 && metricas.contasProximas === 0 && (
                            <p className="text-gray-400">Nenhuma pendente</p>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* Proje√ß√£o e Status */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {/* Saldo Projetado */}
                      <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl p-5 text-white">
                        <h3 className="font-semibold mb-4 text-amber-400">üîÆ Proje√ß√£o Financeira</h3>
                        <div className="space-y-3">
                          <div className="flex justify-between">
                            <span className="text-gray-400">A Receber:</span>
                            <span className="text-green-400 font-medium">+ {formatCurrency(metricas.totalAReceber)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-400">A Pagar:</span>
                            <span className="text-red-400 font-medium">- {formatCurrency(metricas.totalAPagar)}</span>
                          </div>
                          <div className="border-t border-gray-700 pt-3 flex justify-between">
                            <span className="font-medium">Saldo Projetado:</span>
                            <span className={`text-xl font-bold ${metricas.saldoProjetado >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {formatCurrency(metricas.saldoProjetado)}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      {/* Or√ßamentos por Status */}
                      <div className="bg-white rounded-xl shadow p-5">
                        <h3 className="font-semibold text-gray-800 mb-4">üìã Pipeline de Or√ßamentos</h3>
                        <div className="space-y-2">
                          {STATUS_PIPELINE.filter(s => s.id !== 'cancelado').map(status => {
                            const qtd = historico.filter(o => o.status === status.id).length;
                            const valor = historico.filter(o => o.status === status.id).reduce((acc, o) => acc + (o.totais?.total || 0), 0);
                            return (
                              <div key={status.id} className="flex items-center gap-2">
                                <span className={`w-3 h-3 rounded-full ${status.cor}`}></span>
                                <span className="text-sm text-gray-600 flex-1">{status.nome}</span>
                                <span className="text-xs bg-gray-100 px-2 py-0.5 rounded">{qtd}</span>
                                <span className="text-xs text-gray-500 w-24 text-right">{formatCurrency(valor)}</span>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                    
                    {/* √öltimas Transa√ß√µes */}
                    <div className="bg-white rounded-xl shadow p-4">
                      <div className="flex justify-between items-center mb-3">
                        <h3 className="font-semibold text-gray-800">üîÑ √öltimas Movimenta√ß√µes</h3>
                        <button onClick={() => setActiveTab('financeiro')} className="text-sm text-amber-600 hover:text-amber-700">Ver todas ‚Üí</button>
                      </div>
                      {transacoes.length === 0 ? (
                        <p className="text-gray-400 text-center py-4">Nenhuma movimenta√ß√£o registrada</p>
                      ) : (
                        <div className="space-y-2">
                          {transacoes.slice(0, 5).map(t => (
                            <div key={t.id} className="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50">
                              <span className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-sm ${t.tipo === 'receita' ? 'bg-green-500' : 'bg-red-500'}`}>
                                {t.tipo === 'receita' ? '‚Üë' : '‚Üì'}
                              </span>
                              <div className="flex-1">
                                <p className="text-sm font-medium">{t.descricao}</p>
                                <p className="text-xs text-gray-500">{new Date(t.data_transacao).toLocaleDateString('pt-BR')}</p>
                              </div>
                              <span className={`font-medium ${t.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}`}>
                                {t.tipo === 'receita' ? '+' : '-'} {formatCurrency(t.valor)}
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* TAB OR√áAMENTO */}
                {activeTab === 'orcamento' && (
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div className="lg:col-span-2 space-y-4">
                      {/* Dados Or√ßamento */}
                      <div className="bg-white rounded-lg shadow p-4">
                        <h2 className="font-semibold text-gray-800 mb-3">üìã Dados do Or√ßamento</h2>
                        <div className="grid grid-cols-4 gap-3">
                          <div><label className="text-xs text-gray-500 block mb-1">N√∫mero</label><input type="text" value={orcamento.numero} readOnly className="border rounded-lg px-3 py-2 text-sm w-full bg-gray-50 font-mono" /></div>
                          <div><label className="text-xs text-gray-500 block mb-1">Data</label><input type="date" value={orcamento.data} onChange={(e) => setOrcamento({...orcamento, data: e.target.value})} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div><label className="text-xs text-gray-500 block mb-1">Validade</label><input type="number" value={orcamento.validade} onChange={(e) => setOrcamento({...orcamento, validade: parseInt(e.target.value) || 15})} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div>
                            <label className="text-xs text-gray-500 block mb-1">Status</label>
                            <select value={orcamento.status} onChange={(e) => setOrcamento({...orcamento, status: e.target.value})} className={`border rounded-lg px-3 py-2 text-sm w-full font-medium ${getStatusInfo(orcamento.status).cor} text-white`}>
                              {STATUS_PIPELINE.map(s => <option key={s.id} value={s.id} className="bg-white text-gray-800">{s.icon} {s.nome}</option>)}
                            </select>
                          </div>
                        </div>
                      </div>
                      {/* Cliente */}
                      <div className="bg-white rounded-lg shadow p-4">
                        <div className="flex justify-between items-center mb-3">
                          <h2 className="font-semibold text-gray-800">üë§ Dados do Cliente</h2>
                          <button onClick={() => setShowSelecionarCliente(true)} className="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg hover:bg-blue-200 font-medium">üìã Selecionar Cadastrado</button>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                          <div><label className="text-xs text-gray-500 block mb-1">Nome *</label><input type="text" value={orcamento.cliente.nome} onChange={(e) => atualizarCliente('nome', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" placeholder="Nome" /></div>
                          <div><label className="text-xs text-gray-500 block mb-1">Telefone *</label><input type="tel" value={orcamento.cliente.telefone} onChange={(e) => atualizarCliente('telefone', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" placeholder="(45) 99999-9999" /></div>
                          <div><label className="text-xs text-gray-500 block mb-1">E-mail</label><input type="email" value={orcamento.cliente.email} onChange={(e) => atualizarCliente('email', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div><label className="text-xs text-gray-500 block mb-1">CPF/CNPJ</label><input type="text" value={orcamento.cliente.cpfCnpj} onChange={(e) => atualizarCliente('cpfCnpj', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        </div>
                        <div className="border-t mt-4 pt-4 grid grid-cols-6 gap-3">
                          <div className="col-span-4"><label className="text-xs text-gray-500 block mb-1">Endere√ßo</label><input type="text" value={orcamento.cliente.endereco} onChange={(e) => atualizarCliente('endereco', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">N√∫mero</label><input type="text" value={orcamento.cliente.numero} onChange={(e) => atualizarCliente('numero', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div className="col-span-3"><label className="text-xs text-gray-500 block mb-1">Bairro</label><input type="text" value={orcamento.cliente.bairro} onChange={(e) => atualizarCliente('bairro', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Cidade</label><input type="text" value={orcamento.cliente.cidade} onChange={(e) => atualizarCliente('cidade', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div className="col-span-1"><label className="text-xs text-gray-500 block mb-1">UF</label><input type="text" value={orcamento.cliente.estado} onChange={(e) => atualizarCliente('estado', e.target.value)} className="border rounded-lg px-3 py-2 text-sm w-full" maxLength={2} /></div>
                        </div>
                      </div>
                      {/* Itens */}
                      <div className="bg-white rounded-lg shadow p-4">
                        <div className="flex justify-between items-center mb-3">
                          <h2 className="font-semibold text-gray-800">üì¶ Itens</h2>
                          <button onClick={() => setShowAddItem(true)} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium">+ Adicionar</button>
                        </div>
                        {orcamento.itens.length === 0 ? (
                          <div className="text-center py-8 text-gray-400 border-2 border-dashed rounded-lg">Nenhum item</div>
                        ) : (
                          <table className="w-full text-sm">
                            <thead className="bg-gray-50"><tr><th className="text-left p-2">Item</th><th className="text-center p-2">Medidas (L √ó A)</th><th className="text-right p-2">Total Final</th><th></th></tr></thead>
                            <tbody>
                              {orcamento.itens.map(item => {
                                const finalPrice = calcularPrecoFinalItem(item);
                                return (
                                <tr key={item.id} className="border-t">
                                  <td className="p-2">
                                    <p className="font-medium">{item.nome || item.descricao?.split(' (')[0]}</p>
                                    <p className="text-xs text-gray-500">{item.categoria}</p>
                                  </td>
                                  <td className="text-center p-2">
                                    {item.medidaLargura && item.medidaAltura ? (
                                      <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs font-medium">{item.medidaLargura}m √ó {item.medidaAltura}m</span>
                                    ) : '-'}
                                  </td>
                                  <td className="text-right p-2 font-semibold text-amber-600">{formatCurrency(finalPrice)}</td>
                                  <td className="p-2"><button onClick={() => removerItem(item.id)} className="text-red-400 hover:text-red-600">‚úï</button></td>
                                </tr>
                                )
                              })}
                            </tbody>
                          </table>
                        )}
                      </div>
                      {/* Servi√ßos */}
                      <div className="bg-white rounded-lg shadow p-4">
                        <h2 className="font-semibold text-gray-800 mb-3">‚öôÔ∏è Servi√ßos</h2>
                        <div className="grid grid-cols-2 gap-3">
                          <div><label className="text-xs text-gray-500 block mb-1">M√£o de Obra</label><input type="number" value={orcamento.custoMaoObra || ''} onChange={(e) => setOrcamento({...orcamento, custoMaoObra: parseFloat(e.target.value) || 0})} className="border rounded-lg px-3 py-2 text-sm w-full" placeholder="R$ 0,00" /></div>
                          <div><label className="text-xs text-gray-500 block mb-1">Instala√ß√£o</label><input type="number" value={orcamento.custoInstalacao || ''} onChange={(e) => setOrcamento({...orcamento, custoInstalacao: parseFloat(e.target.value) || 0})} className="border rounded-lg px-3 py-2 text-sm w-full" placeholder="R$ 0,00" /></div>
                          <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Prazo</label><input type="text" value={orcamento.prazoEntrega} onChange={(e) => setOrcamento({...orcamento, prazoEntrega: e.target.value})} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Pagamento</label><input type="text" value={orcamento.formaPagamento} onChange={(e) => setOrcamento({...orcamento, formaPagamento: e.target.value})} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                          <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Observa√ß√µes</label><textarea value={orcamento.observacoes} onChange={(e) => setOrcamento({...orcamento, observacoes: e.target.value})} className="border rounded-lg px-3 py-2 text-sm w-full" rows={2} /></div>
                        </div>
                      </div>
                    </div>
                    {/* Lateral */}
                    <div className="space-y-4">
                      <div className="bg-white rounded-lg shadow p-4">
                        <h2 className="font-semibold text-gray-800 mb-3">üìä Markup</h2>
                        <input type="number" value={orcamento.markup} onChange={(e) => setOrcamento({...orcamento, markup: parseFloat(e.target.value) || 0})} className="border rounded-lg px-3 py-2 w-full text-lg font-bold text-center mb-2" />
                        <div className="flex gap-1">{[50,80,100,120,150].map(v => <button key={v} onClick={() => setOrcamento({...orcamento, markup: v})} className={`flex-1 text-xs py-1.5 rounded ${orcamento.markup === v ? 'bg-amber-500 text-white' : 'bg-gray-100'}`}>{v}%</button>)}</div>
                        <div className="mt-3"><label className="text-xs text-gray-500 block mb-1">Desconto %</label><input type="number" value={orcamento.desconto || ''} onChange={(e) => setOrcamento({...orcamento, desconto: parseFloat(e.target.value) || 0})} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                      </div>
                      <div className="bg-gradient-to-br from-slate-800 to-slate-900 rounded-lg shadow-lg p-4 text-white">
                        <h2 className="font-semibold mb-4 text-amber-400">üí∞ Resumo</h2>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between"><span className="text-gray-400">Custo Materiais:</span><span>{formatCurrency(totais.custoMateriais)}</span></div>
                          <div className="flex justify-between"><span className="text-gray-400">M√£o de Obra:</span><span>{formatCurrency(orcamento.custoMaoObra)}</span></div>
                          <div className="flex justify-between"><span className="text-gray-400">Instala√ß√£o:</span><span>{formatCurrency(orcamento.custoInstalacao)}</span></div>
                          <div className="border-t border-gray-600 my-2"></div>
                          <div className="flex justify-between font-medium"><span>CUSTO TOTAL:</span><span className="text-red-400">{formatCurrency(totais.custoTotal)}</span></div>
                          <div className="border-t border-gray-600 my-2"></div>
                          <div className="flex justify-between text-xs"><span className="text-gray-500">Venda Materiais ({orcamento.markup}%):</span><span className="text-gray-400">{formatCurrency(totais.vendaMateriais)}</span></div>
                          <div className="flex justify-between text-xs"><span className="text-gray-500">+ Servi√ßos:</span><span className="text-gray-400">{formatCurrency(totais.custoServicos)}</span></div>
                          {orcamento.desconto > 0 && <div className="flex justify-between text-xs"><span className="text-gray-500">- Desconto ({orcamento.desconto}%):</span><span className="text-red-300">-{formatCurrency(totais.valorDesconto)}</span></div>}
                        </div>
                        <div className="mt-4 p-3 bg-amber-500/20 border border-amber-500/30 rounded-lg">
                          <p className="text-xs text-amber-300">VENDA (Final)</p>
                          <p className="text-3xl font-bold text-amber-400">{formatCurrency(totais.total)}</p>
                        </div>
                        <div className="mt-3 grid grid-cols-2 gap-2">
                          <div className="bg-green-900/50 rounded-lg p-2 text-center"><p className="text-xs text-green-300">LUCRO</p><p className="font-bold text-green-400">{formatCurrency(totais.lucro)}</p></div>
                          <div className="bg-blue-900/50 rounded-lg p-2 text-center"><p className="text-xs text-blue-300">MARGEM</p><p className="font-bold text-blue-400">{formatPercent(totais.margem)}</p></div>
                        </div>
                      </div>
                      <div className="space-y-2">
                        <button onClick={() => setShowPreview(true)} disabled={orcamento.itens.length === 0} className={`w-full py-2.5 rounded-lg font-medium ${orcamento.itens.length === 0 ? 'bg-gray-200 text-gray-400' : 'bg-white border-2 border-slate-800 text-slate-800 hover:bg-slate-50'}`}>üëÅÔ∏è Visualizar</button>
                        <button onClick={salvarOrcamento} disabled={orcamento.itens.length === 0 || salvando} className={`w-full py-2.5 rounded-lg font-medium ${orcamento.itens.length === 0 ? 'bg-gray-200 text-gray-400' : 'bg-amber-500 text-white hover:bg-amber-600'}`}>{salvando ? '‚è≥...' : editandoId ? 'üíæ Atualizar' : 'üíæ Salvar'}</button>
                        <button onClick={limparOrcamento} className="w-full py-2 rounded-lg border border-red-200 text-red-500 hover:bg-red-50 text-sm">üóëÔ∏è Limpar</button>
                      </div>
                    </div>
                  </div>
                )}

                {/* TAB CAT√ÅLOGO (integrado com gest√£o de produtos/fornecedores) */}
                {activeTab === 'catalogo' && (
                  <div className="space-y-4">
                    {/* Barra de ferramentas */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-wrap items-center gap-3 mb-3">
                        <input type="text" placeholder="üîç Buscar produto por nome ou c√≥digo..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="flex-1 min-w-[200px] border rounded-lg px-3 py-2" />
                        <select value={categoriaFiltro} onChange={(e) => setCategoriaFiltro(e.target.value)} className="border rounded-lg px-3 py-2 text-sm">
                          <option value="todos">Todas Categorias</option>
                          {categorias.map(c => <option key={c} value={c}>{c}</option>)}
                        </select>
                      </div>
                      <div className="flex flex-wrap gap-2">
                        <button onClick={() => { setFornecedorEditando(null); setShowFornecedorModal(true); }} className="bg-slate-700 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-slate-800 text-sm">üè≠ + Fornecedor</button>
                        <button onClick={() => { setProdutoEditando(null); setShowProdutoModal(true); }} className="bg-amber-500 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-amber-600 text-sm">üì¶ + Produto</button>
                        <button onClick={() => setShowImportarPDF(true)} className="bg-blue-600 text-white px-3 py-1.5 rounded-lg font-medium hover:bg-blue-700 text-sm">üìÑ Importar PDF</button>
                      </div>
                    </div>
                    
                    {/* Lista de Fornecedores */}
                    {fornecedores.length > 0 && (
                      <div className="bg-white rounded-lg shadow p-4">
                        <h3 className="font-semibold text-gray-800 mb-3 text-sm">üè≠ Fornecedores ({fornecedores.length})</h3>
                        <div className="flex flex-wrap gap-2">
                          {fornecedores.map(forn => (
                            <div key={forn.id} className="bg-gray-100 rounded-lg px-3 py-2 flex items-center gap-2 text-sm">
                              <span className="font-medium">{forn.nome}</span>
                              {forn.cidade && <span className="text-gray-500 text-xs">({forn.cidade})</span>}
                              <button onClick={() => { setFornecedorEditando(forn); setShowFornecedorModal(true); }} className="text-blue-600 hover:text-blue-800">‚úèÔ∏è</button>
                              <button onClick={() => excluirFornecedor(forn.id)} className="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                    
                    {/* Tabela de Produtos */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <div className="p-3 bg-gray-50 border-b flex justify-between items-center">
                        <span className="text-sm font-medium text-gray-700">üì¶ Produtos ({produtosFiltrados.length})</span>
                        <span className="text-xs text-gray-500">Clique em "+ Add" para adicionar ao or√ßamento</span>
                      </div>
                      <div className="max-h-[50vh] overflow-y-auto">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-50 sticky top-0">
                            <tr>
                              <th className="text-left p-3">C√≥digo</th>
                              <th className="text-left p-3">Produto</th>
                              <th className="text-left p-3">Categoria</th>
                              <th className="text-center p-3">Un</th>
                              <th className="text-right p-3">Custo</th>
                              <th className="text-center p-3">A√ß√µes</th>
                            </tr>
                          </thead>
                          <tbody>
                            {produtosFiltrados.map(p => (
                              <tr key={p.codigo} className="border-t hover:bg-amber-50">
                                <td className="p-3 text-xs font-mono text-gray-500">{p.codigo}</td>
                                <td className="p-3">
                                  <span className="font-medium">{p.nome}</span>
                                  {p.fornecedor && <span className="text-xs text-gray-400 ml-2">({p.fornecedor})</span>}
                                </td>
                                <td className="p-3"><span className="bg-gray-100 px-2 py-0.5 rounded text-xs">{p.categoria}</span></td>
                                <td className="p-3 text-center text-xs text-gray-500">{p.unidade || 'un'}</td>
                                <td className="text-right p-3 font-semibold text-amber-600">{formatCurrency(p.preco)}</td>
                                <td className="p-3 text-center">
                                  <div className="flex justify-center gap-1">
                                    <button onClick={() => { setItemSelecionado(p); setCustoUnitario(p.preco); setShowAddItem(true); setMedidaLargura(''); setMedidaAltura(''); }} className="bg-amber-100 text-amber-700 px-2 py-1 rounded text-xs font-medium hover:bg-amber-200">+ Add</button>
                                    {p.doBanco && (
                                      <>
                                        <button onClick={() => { setProdutoEditando(produtosBanco.find(pb => pb.codigo === p.codigo)); setShowProdutoModal(true); }} className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs hover:bg-blue-200">‚úèÔ∏è</button>
                                        <button onClick={() => excluirProduto(produtosBanco.find(pb => pb.codigo === p.codigo)?.id)} className="bg-red-50 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-100">üóëÔ∏è</button>
                                      </>
                                    )}
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* TAB CLIENTES */}
                {activeTab === 'clientes' && (
                  <div className="space-y-4">
                    {/* Header com busca e bot√£o novo */}
                    <div className="bg-white rounded-lg shadow p-4 flex flex-wrap items-center gap-3">
                      <input type="text" placeholder="üîç Buscar cliente..." value={buscaCliente} onChange={(e) => setBuscaCliente(e.target.value)} className="flex-1 min-w-[200px] border rounded-lg px-3 py-2" />
                      <button onClick={() => { setClienteEditando(null); setShowClienteModal(true); }} className="bg-amber-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-amber-600">+ Novo Cliente</button>
                    </div>
                    
                    {/* Lista de Clientes */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      {clientes.filter(c => 
                        c.nome?.toLowerCase().includes(buscaCliente.toLowerCase()) ||
                        c.telefone?.includes(buscaCliente) ||
                        c.email?.toLowerCase().includes(buscaCliente.toLowerCase())
                      ).length === 0 ? (
                        <div className="p-12 text-center text-gray-400">
                          {clientes.length === 0 ? 'üë• Nenhum cliente cadastrado' : 'üîç Nenhum cliente encontrado'}
                        </div>
                      ) : (
                        <table className="w-full text-sm">
                          <thead className="bg-gray-50">
                            <tr>
                              <th className="text-left p-3">Cliente</th>
                              <th className="text-left p-3">Contato</th>
                              <th className="text-left p-3">Endere√ßo</th>
                              <th className="text-center p-3">A√ß√µes</th>
                            </tr>
                          </thead>
                          <tbody>
                            {clientes.filter(c => 
                              c.nome?.toLowerCase().includes(buscaCliente.toLowerCase()) ||
                              c.telefone?.includes(buscaCliente) ||
                              c.email?.toLowerCase().includes(buscaCliente.toLowerCase())
                            ).map(cliente => (
                              <tr key={cliente.id} className="border-t hover:bg-amber-50">
                                <td className="p-3">
                                  <p className="font-medium">{cliente.nome}</p>
                                  {cliente.cpf_cnpj && <p className="text-xs text-gray-500">{cliente.cpf_cnpj}</p>}
                                </td>
                                <td className="p-3">
                                  {cliente.telefone && <p className="text-sm">üì± {cliente.telefone}</p>}
                                  {cliente.email && <p className="text-xs text-gray-500">‚úâÔ∏è {cliente.email}</p>}
                                </td>
                                <td className="p-3">
                                  {cliente.endereco && <p className="text-sm truncate max-w-[200px]">{cliente.endereco}, {cliente.numero}</p>}
                                  {cliente.cidade && <p className="text-xs text-gray-500">{cliente.cidade}/{cliente.estado}</p>}
                                </td>
                                <td className="p-3 text-center">
                                  <div className="flex justify-center gap-1">
                                    <button onClick={() => { setClienteEditando(cliente); setShowClienteModal(true); }} className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs hover:bg-blue-200">‚úèÔ∏è</button>
                                    <button onClick={() => excluirCliente(cliente.id)} className="bg-red-50 text-red-600 px-2 py-1 rounded text-xs hover:bg-red-100">üóëÔ∏è</button>
                                  </div>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      )}
                    </div>
                  </div>
                )}

                {/* TAB FINANCEIRO */}
                {activeTab === 'financeiro' && (
                  <div className="space-y-4">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-wrap items-center gap-3">
                        <button onClick={() => { setTransacaoEditando(null); setShowTransacaoModal(true); }} className="bg-amber-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-amber-600 text-sm">+ Nova Transa√ß√£o</button>
                        <button onClick={() => { setContaPagarEditando(null); setShowContaPagarModal(true); }} className="bg-red-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-red-600 text-sm">+ Conta a Pagar</button>
                        <button onClick={() => { setContaReceberEditando(null); setShowContaReceberModal(true); }} className="bg-green-500 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-600 text-sm">+ Conta a Receber</button>
                      </div>
                    </div>
                    
                    {/* Resumo R√°pido */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                      <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                        <p className="text-xs text-green-600 uppercase">Receitas (M√™s)</p>
                        <p className="text-xl font-bold text-green-700">{formatCurrency(metricas.totalReceitasMes)}</p>
                      </div>
                      <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                        <p className="text-xs text-red-600 uppercase">Despesas (M√™s)</p>
                        <p className="text-xl font-bold text-red-700">{formatCurrency(metricas.totalDespesasMes)}</p>
                      </div>
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p className="text-xs text-blue-600 uppercase">A Receber</p>
                        <p className="text-xl font-bold text-blue-700">{formatCurrency(metricas.totalAReceber)}</p>
                      </div>
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <p className="text-xs text-amber-600 uppercase">A Pagar</p>
                        <p className="text-xl font-bold text-amber-700">{formatCurrency(metricas.totalAPagar)}</p>
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {/* Contas a Receber */}
                      <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="p-4 bg-green-50 border-b border-green-100 flex justify-between items-center">
                          <h3 className="font-semibold text-green-800">üíµ Contas a Receber</h3>
                          <span className="text-sm text-green-600">{contasReceber.filter(c => c.status === 'pendente').length} pendente(s)</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto">
                          {contasReceber.filter(c => c.status === 'pendente').length === 0 ? (
                            <p className="p-4 text-gray-400 text-center">Nenhuma conta a receber</p>
                          ) : (
                            contasReceber.filter(c => c.status === 'pendente').map(conta => {
                              const vencida = new Date(conta.data_vencimento) < new Date();
                              return (
                                <div key={conta.id} className={`p-3 border-b flex items-center gap-3 ${vencida ? 'bg-red-50' : ''}`}>
                                  <div className="flex-1">
                                    <p className="font-medium text-sm">{conta.descricao}</p>
                                    <p className="text-xs text-gray-500">{conta.clientes?.nome || 'Sem cliente'}</p>
                                    <p className={`text-xs ${vencida ? 'text-red-500 font-medium' : 'text-gray-400'}`}>
                                      {vencida ? '‚ö†Ô∏è Vencido: ' : 'Vence: '}{new Date(conta.data_vencimento).toLocaleDateString('pt-BR')}
                                    </p>
                                  </div>
                                  <div className="text-right">
                                    <p className="font-bold text-green-600">{formatCurrency(conta.valor)}</p>
                                    <div className="flex gap-1 mt-1">
                                      <button onClick={() => receberConta(conta)} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">‚úì Receber</button>
                                      <button onClick={() => excluirContaReceber(conta.id)} className="text-xs bg-red-50 text-red-500 px-2 py-1 rounded hover:bg-red-100">üóëÔ∏è</button>
                                    </div>
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      </div>
                      
                      {/* Contas a Pagar */}
                      <div className="bg-white rounded-lg shadow overflow-hidden">
                        <div className="p-4 bg-red-50 border-b border-red-100 flex justify-between items-center">
                          <h3 className="font-semibold text-red-800">üí∏ Contas a Pagar</h3>
                          <span className="text-sm text-red-600">{contasPagar.filter(c => c.status === 'pendente').length} pendente(s)</span>
                        </div>
                        <div className="max-h-[300px] overflow-y-auto">
                          {contasPagar.filter(c => c.status === 'pendente').length === 0 ? (
                            <p className="p-4 text-gray-400 text-center">Nenhuma conta a pagar</p>
                          ) : (
                            contasPagar.filter(c => c.status === 'pendente').map(conta => {
                              const vencida = new Date(conta.data_vencimento) < new Date();
                              return (
                                <div key={conta.id} className={`p-3 border-b flex items-center gap-3 ${vencida ? 'bg-red-50' : ''}`}>
                                  <div className="flex-1">
                                    <p className="font-medium text-sm">{conta.descricao}</p>
                                    <p className="text-xs text-gray-500">{conta.fornecedores?.nome || 'Sem fornecedor'}</p>
                                    <p className={`text-xs ${vencida ? 'text-red-500 font-medium' : 'text-gray-400'}`}>
                                      {vencida ? '‚ö†Ô∏è Vencido: ' : 'Vence: '}{new Date(conta.data_vencimento).toLocaleDateString('pt-BR')}
                                    </p>
                                  </div>
                                  <div className="text-right">
                                    <p className="font-bold text-red-600">{formatCurrency(conta.valor)}</p>
                                    <div className="flex gap-1 mt-1">
                                      <button onClick={() => pagarConta(conta)} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded hover:bg-green-200">‚úì Pagar</button>
                                      <button onClick={() => excluirContaPagar(conta.id)} className="text-xs bg-red-50 text-red-500 px-2 py-1 rounded hover:bg-red-100">üóëÔ∏è</button>
                                    </div>
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* Extrato de Transa√ß√µes */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                      <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 className="font-semibold text-gray-800">üìú Extrato de Transa√ß√µes</h3>
                        <span className="text-sm text-gray-500">{transacoes.length} lan√ßamento(s)</span>
                      </div>
                      {transacoes.length === 0 ? (
                        <p className="p-8 text-gray-400 text-center">Nenhuma transa√ß√£o registrada</p>
                      ) : (
                        <div className="max-h-[400px] overflow-y-auto">
                          <table className="w-full text-sm">
                            <thead className="bg-gray-50 sticky top-0">
                              <tr>
                                <th className="text-left p-3">Data</th>
                                <th className="text-left p-3">Descri√ß√£o</th>
                                <th className="text-left p-3">Categoria</th>
                                <th className="text-right p-3">Valor</th>
                                <th className="text-center p-3">A√ß√µes</th>
                              </tr>
                            </thead>
                            <tbody>
                              {transacoes.map(t => (
                                <tr key={t.id} className="border-t hover:bg-gray-50">
                                  <td className="p-3 text-gray-600">{new Date(t.data_transacao).toLocaleDateString('pt-BR')}</td>
                                  <td className="p-3 font-medium">{t.descricao}</td>
                                  <td className="p-3">
                                    <span className="text-xs px-2 py-0.5 rounded" style={{backgroundColor: t.categorias_financeiras?.cor + '20', color: t.categorias_financeiras?.cor}}>
                                      {t.categorias_financeiras?.nome || '-'}
                                    </span>
                                  </td>
                                  <td className={`p-3 text-right font-medium ${t.tipo === 'receita' ? 'text-green-600' : 'text-red-600'}`}>
                                    {t.tipo === 'receita' ? '+' : '-'} {formatCurrency(t.valor)}
                                  </td>
                                  <td className="p-3 text-center">
                                    <button onClick={() => excluirTransacao(t.id)} className="text-red-500 hover:text-red-700">üóëÔ∏è</button>
                                  </td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* TAB RELAT√ìRIOS */}
                {activeTab === 'relatorios' && (
                  <div className="space-y-4">
                    {/* Seletor de Per√≠odo */}
                    <div className="bg-white rounded-lg shadow p-4 flex flex-wrap items-center gap-3">
                      <label className="text-sm text-gray-600">Per√≠odo:</label>
                      <input type="month" value={mesRelatorio} onChange={(e) => setMesRelatorio(e.target.value)} className="border rounded-lg px-3 py-2 text-sm" />
                      <div className="flex gap-1">
                        <button onClick={() => setPeriodoFinanceiro('mes')} className={`px-3 py-1.5 rounded text-sm ${periodoFinanceiro === 'mes' ? 'bg-amber-500 text-white' : 'bg-gray-100'}`}>M√™s</button>
                        <button onClick={() => setPeriodoFinanceiro('trimestre')} className={`px-3 py-1.5 rounded text-sm ${periodoFinanceiro === 'trimestre' ? 'bg-amber-500 text-white' : 'bg-gray-100'}`}>Trimestre</button>
                        <button onClick={() => setPeriodoFinanceiro('ano')} className={`px-3 py-1.5 rounded text-sm ${periodoFinanceiro === 'ano' ? 'bg-amber-500 text-white' : 'bg-gray-100'}`}>Ano</button>
                      </div>
                    </div>
                    
                    {/* Relat√≥rio de Vendas */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <h3 className="font-semibold text-gray-800 mb-4">üìä Relat√≥rio de Vendas</h3>
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div className="bg-blue-50 rounded-lg p-3">
                          <p className="text-xs text-blue-600">Total de Or√ßamentos</p>
                          <p className="text-2xl font-bold text-blue-700">{historico.length}</p>
                        </div>
                        <div className="bg-green-50 rounded-lg p-3">
                          <p className="text-xs text-green-600">Valor Total Or√ßado</p>
                          <p className="text-xl font-bold text-green-700">{formatCurrency(metricas.valorTotalOrcamentos)}</p>
                        </div>
                        <div className="bg-amber-50 rounded-lg p-3">
                          <p className="text-xs text-amber-600">Valor Aprovado</p>
                          <p className="text-xl font-bold text-amber-700">{formatCurrency(metricas.valorAprovado)}</p>
                        </div>
                        <div className="bg-purple-50 rounded-lg p-3">
                          <p className="text-xs text-purple-600">Taxa de Convers√£o</p>
                          <p className="text-2xl font-bold text-purple-700">{metricas.taxaConversao}%</p>
                        </div>
                      </div>
                      
                      {/* Vendas por Status */}
                      <h4 className="font-medium text-gray-700 mb-2">Por Status</h4>
                      <div className="space-y-2 mb-4">
                        {STATUS_PIPELINE.map(status => {
                          const orcs = historico.filter(o => o.status === status.id);
                          const valor = orcs.reduce((acc, o) => acc + (o.totais?.total || 0), 0);
                          const pct = historico.length > 0 ? (orcs.length / historico.length * 100).toFixed(1) : 0;
                          return (
                            <div key={status.id} className="flex items-center gap-3">
                              <span className={`w-3 h-3 rounded-full ${status.cor}`}></span>
                              <span className="text-sm flex-1">{status.nome}</span>
                              <span className="text-sm text-gray-500">{orcs.length} ({pct}%)</span>
                              <span className="text-sm font-medium w-28 text-right">{formatCurrency(valor)}</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* Top Clientes */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <h3 className="font-semibold text-gray-800 mb-4">üèÜ Top 10 Clientes</h3>
                      {(() => {
                        const clientesAgrupados = {};
                        historico.forEach(o => {
                          const nome = o.cliente?.nome || 'Sem nome';
                          if (!clientesAgrupados[nome]) clientesAgrupados[nome] = { qtd: 0, valor: 0 };
                          clientesAgrupados[nome].qtd++;
                          clientesAgrupados[nome].valor += o.totais?.total || 0;
                        });
                        const topClientes = Object.entries(clientesAgrupados)
                          .map(([nome, dados]) => ({ nome, ...dados }))
                          .sort((a, b) => b.valor - a.valor)
                          .slice(0, 10);
                        return topClientes.length === 0 ? (
                          <p className="text-gray-400 text-center py-4">Nenhum cliente encontrado</p>
                        ) : (
                          <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                              <tr>
                                <th className="text-left p-2">#</th>
                                <th className="text-left p-2">Cliente</th>
                                <th className="text-center p-2">Or√ßamentos</th>
                                <th className="text-right p-2">Valor Total</th>
                              </tr>
                            </thead>
                            <tbody>
                              {topClientes.map((c, i) => (
                                <tr key={c.nome} className="border-t">
                                  <td className="p-2 text-gray-500">{i + 1}¬∫</td>
                                  <td className="p-2 font-medium">{c.nome}</td>
                                  <td className="p-2 text-center">{c.qtd}</td>
                                  <td className="p-2 text-right font-medium text-amber-600">{formatCurrency(c.valor)}</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        );
                      })()}
                    </div>
                    
                    {/* Relat√≥rio Financeiro */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <h3 className="font-semibold text-gray-800 mb-4">üí∞ Relat√≥rio Financeiro</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {/* Receitas por Categoria */}
                        <div>
                          <h4 className="font-medium text-green-700 mb-2">üìà Receitas por Categoria</h4>
                          {(() => {
                            const receitasPorCat = {};
                            transacoes.filter(t => t.tipo === 'receita').forEach(t => {
                              const cat = t.categorias_financeiras?.nome || 'Outros';
                              receitasPorCat[cat] = (receitasPorCat[cat] || 0) + parseFloat(t.valor);
                            });
                            const cats = Object.entries(receitasPorCat).sort((a, b) => b[1] - a[1]);
                            return cats.length === 0 ? (
                              <p className="text-gray-400 text-sm">Nenhuma receita</p>
                            ) : (
                              <div className="space-y-2">
                                {cats.map(([cat, valor]) => (
                                  <div key={cat} className="flex justify-between text-sm">
                                    <span>{cat}</span>
                                    <span className="font-medium text-green-600">{formatCurrency(valor)}</span>
                                  </div>
                                ))}
                              </div>
                            );
                          })()}
                        </div>
                        
                        {/* Despesas por Categoria */}
                        <div>
                          <h4 className="font-medium text-red-700 mb-2">üìâ Despesas por Categoria</h4>
                          {(() => {
                            const despesasPorCat = {};
                            transacoes.filter(t => t.tipo === 'despesa').forEach(t => {
                              const cat = t.categorias_financeiras?.nome || 'Outros';
                              despesasPorCat[cat] = (despesasPorCat[cat] || 0) + parseFloat(t.valor);
                            });
                            const cats = Object.entries(despesasPorCat).sort((a, b) => b[1] - a[1]);
                            return cats.length === 0 ? (
                              <p className="text-gray-400 text-sm">Nenhuma despesa</p>
                            ) : (
                              <div className="space-y-2">
                                {cats.map(([cat, valor]) => (
                                  <div key={cat} className="flex justify-between text-sm">
                                    <span>{cat}</span>
                                    <span className="font-medium text-red-600">{formatCurrency(valor)}</span>
                                  </div>
                                ))}
                              </div>
                            );
                          })()}
                        </div>
                      </div>
                      
                      {/* Resumo */}
                      <div className="mt-4 pt-4 border-t">
                        <div className="bg-gray-50 rounded-lg p-4">
                          <div className="flex justify-between mb-2">
                            <span>Total Receitas:</span>
                            <span className="font-medium text-green-600">{formatCurrency(transacoes.filter(t => t.tipo === 'receita').reduce((acc, t) => acc + parseFloat(t.valor), 0))}</span>
                          </div>
                          <div className="flex justify-between mb-2">
                            <span>Total Despesas:</span>
                            <span className="font-medium text-red-600">{formatCurrency(transacoes.filter(t => t.tipo === 'despesa').reduce((acc, t) => acc + parseFloat(t.valor), 0))}</span>
                          </div>
                          <div className="flex justify-between font-bold text-lg pt-2 border-t">
                            <span>Resultado:</span>
                            <span className={transacoes.filter(t => t.tipo === 'receita').reduce((acc, t) => acc + parseFloat(t.valor), 0) - transacoes.filter(t => t.tipo === 'despesa').reduce((acc, t) => acc + parseFloat(t.valor), 0) >= 0 ? 'text-green-600' : 'text-red-600'}>
                              {formatCurrency(transacoes.filter(t => t.tipo === 'receita').reduce((acc, t) => acc + parseFloat(t.valor), 0) - transacoes.filter(t => t.tipo === 'despesa').reduce((acc, t) => acc + parseFloat(t.valor), 0))}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* TAB HIST√ìRICO */}
                {activeTab === 'historico' && (
                  <div className="space-y-4">
                    {/* Controles de Visualiza√ß√£o */}
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-wrap items-center gap-3 mb-3">
                        <div className="flex gap-1 bg-gray-100 p-1 rounded-lg">
                          <button onClick={() => setViewMode('lista')} className={`px-3 py-1.5 rounded text-sm font-medium transition ${viewMode === 'lista' ? 'bg-white shadow text-slate-800' : 'text-gray-500 hover:text-gray-700'}`}>üìã Lista</button>
                          <button onClick={() => setViewMode('kanban')} className={`px-3 py-1.5 rounded text-sm font-medium transition ${viewMode === 'kanban' ? 'bg-white shadow text-slate-800' : 'text-gray-500 hover:text-gray-700'}`}>üìä Kanban</button>
                        </div>
                        <select value={filtroStatus} onChange={(e) => setFiltroStatus(e.target.value)} className="border rounded-lg px-3 py-2 text-sm">
                          <option value="todos">Todos os Status</option>
                          {STATUS_PIPELINE.map(s => <option key={s.id} value={s.id}>{s.icon} {s.nome}</option>)}
                        </select>
                        <input type="text" placeholder="üîç Buscar nome, telefone, CPF, n¬∫ pedido..." value={buscaHistorico} onChange={(e) => setBuscaHistorico(e.target.value)} className="flex-1 min-w-[200px] border rounded-lg px-3 py-2 text-sm" />
                      </div>
                      <div className="flex flex-wrap items-center gap-3">
                        <div className="flex items-center gap-2">
                          <label className="text-xs text-gray-500">De:</label>
                          <input type="date" value={filtroDataInicio} onChange={(e) => setFiltroDataInicio(e.target.value)} className="border rounded-lg px-2 py-1.5 text-sm" />
                        </div>
                        <div className="flex items-center gap-2">
                          <label className="text-xs text-gray-500">At√©:</label>
                          <input type="date" value={filtroDataFim} onChange={(e) => setFiltroDataFim(e.target.value)} className="border rounded-lg px-2 py-1.5 text-sm" />
                        </div>
                        <div className="flex gap-1">
                          <button onClick={() => { const d = new Date(); setFiltroDataInicio(new Date(d.setDate(d.getDate() - 7)).toISOString().split('T')[0]); setFiltroDataFim(new Date().toISOString().split('T')[0]); }} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">7d</button>
                          <button onClick={() => { const d = new Date(); setFiltroDataInicio(new Date(d.setDate(d.getDate() - 30)).toISOString().split('T')[0]); setFiltroDataFim(new Date().toISOString().split('T')[0]); }} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">30d</button>
                          <button onClick={() => { const d = new Date(); setFiltroDataInicio(new Date(d.setDate(d.getDate() - 90)).toISOString().split('T')[0]); setFiltroDataFim(new Date().toISOString().split('T')[0]); }} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">90d</button>
                          <button onClick={() => { setFiltroDataInicio('2020-01-01'); setFiltroDataFim(new Date().toISOString().split('T')[0]); }} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">Todos</button>
                        </div>
                        <div className="ml-auto text-sm text-gray-500">
                          {historico.filter(o => {
                            const dataOrc = new Date(o.dataSalvo).toISOString().split('T')[0];
                            const matchStatus = filtroStatus === 'todos' || o.status === filtroStatus;
                            const matchData = dataOrc >= filtroDataInicio && dataOrc <= filtroDataFim;
                            const termoBusca = buscaHistorico.toLowerCase();
                            const matchBusca = !buscaHistorico || 
                              o.cliente?.nome?.toLowerCase().includes(termoBusca) ||
                              o.cliente?.telefone?.includes(termoBusca) ||
                              o.cliente?.cpfCnpj?.includes(termoBusca) ||
                              o.numero?.toLowerCase().includes(termoBusca);
                            return matchStatus && matchData && matchBusca;
                          }).length} or√ßamento(s)
                        </div>
                      </div>
                    </div>

                    {carregando ? <div className="bg-white rounded-lg shadow p-12 text-center text-gray-400">‚è≥ Carregando...</div> :
                     historico.length === 0 ? <div className="bg-white rounded-lg shadow p-12 text-center text-gray-400">üìÅ Nenhum or√ßamento</div> :
                     
                     /* MODO LISTA */
                     viewMode === 'lista' ? (
                       <div className="space-y-3">
                         {historico.filter(o => {
                           const dataOrc = new Date(o.dataSalvo).toISOString().split('T')[0];
                           const matchStatus = filtroStatus === 'todos' || o.status === filtroStatus;
                           const matchData = dataOrc >= filtroDataInicio && dataOrc <= filtroDataFim;
                           const termoBusca = buscaHistorico.toLowerCase();
                           const matchBusca = !buscaHistorico || 
                             o.cliente?.nome?.toLowerCase().includes(termoBusca) ||
                             o.cliente?.telefone?.includes(termoBusca) ||
                             o.cliente?.cpfCnpj?.includes(termoBusca) ||
                             o.numero?.toLowerCase().includes(termoBusca);
                           return matchStatus && matchData && matchBusca;
                         }).map(orc => {
                           const statusInfo = getStatusInfo(orc.status);
                           return (
                           <div key={orc.id} className="bg-white rounded-lg shadow p-4">
                             <div className="flex justify-between items-start">
                               <div>
                                 <div className="flex items-center gap-2 flex-wrap">
                                   <span className="bg-slate-800 text-white text-xs px-2 py-0.5 rounded font-mono">{orc.numero}</span>
                                   <span className={`text-xs px-2 py-0.5 rounded-full text-white ${statusInfo.cor}`}>{statusInfo.icon} {statusInfo.nome}</span>
                                   <span className="text-sm text-gray-500">{new Date(orc.dataSalvo).toLocaleDateString('pt-BR')}</span>
                                 </div>
                                 <h3 className="font-semibold text-lg mt-1">{orc.cliente.nome || 'Sem nome'}</h3>
                                 {orc.cliente.telefone && <p className="text-sm text-gray-500">üì± {orc.cliente.telefone}</p>}
                               </div>
                               <div className="text-right">
                                 <p className="text-xs text-gray-500">Total</p>
                                 <p className="text-2xl font-bold text-amber-600">{formatCurrency(orc.totais?.total || 0)}</p>
                               </div>
                             </div>
                             {/* Seletor de Status */}
                             <div className="mt-3 pt-3 border-t">
                               <div className="flex flex-wrap gap-1 mb-3">
                                 {STATUS_PIPELINE.map(s => (
                                   <button key={s.id} onClick={() => mudarStatus(orc.id, s.id)} 
                                     className={`text-xs px-2 py-1 rounded-full transition ${orc.status === s.id ? `${s.cor} text-white` : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                     {s.icon}
                                   </button>
                                 ))}
                               </div>
                               <div className="flex gap-2">
                                 <button onClick={() => editarOrcamento(orc)} className="text-sm bg-blue-100 text-blue-700 px-4 py-1.5 rounded-lg hover:bg-blue-200 font-medium">‚úèÔ∏è Editar</button>
                                 <button onClick={() => duplicarOrcamento(orc)} className="text-sm bg-amber-100 text-amber-700 px-4 py-1.5 rounded-lg hover:bg-amber-200 font-medium">üìã Duplicar</button>
                                 <button onClick={() => excluirOrcamento(orc.id)} className="text-sm bg-red-50 text-red-600 px-4 py-1.5 rounded-lg hover:bg-red-100">üóëÔ∏è</button>
                               </div>
                             </div>
                           </div>
                           );
                         })}
                       </div>
                     ) : 
                     
                     /* MODO KANBAN */
                     (
                       <div className="overflow-x-auto pb-4">
                         <div className="flex gap-4 min-w-max">
                           {STATUS_PIPELINE.filter(s => s.id !== 'cancelado' && (filtroStatus === 'todos' || s.id === filtroStatus)).map(status => {
                             const orcamentosStatus = historico.filter(o => {
                               const dataOrc = new Date(o.dataSalvo).toISOString().split('T')[0];
                               const termoBusca = buscaHistorico.toLowerCase();
                               const matchBusca = !buscaHistorico || 
                                 o.cliente?.nome?.toLowerCase().includes(termoBusca) ||
                                 o.cliente?.telefone?.includes(termoBusca) ||
                                 o.cliente?.cpfCnpj?.includes(termoBusca) ||
                                 o.numero?.toLowerCase().includes(termoBusca);
                               return o.status === status.id && dataOrc >= filtroDataInicio && dataOrc <= filtroDataFim && matchBusca;
                             });
                             return (
                               <div key={status.id} className={`${filtroStatus === 'todos' ? 'w-72' : 'w-96'} flex-shrink-0`}>
                                 <div className={`${status.cor} text-white p-3 rounded-t-lg flex items-center justify-between`}>
                                   <span className="font-medium">{status.icon} {status.nome}</span>
                                   <span className="bg-white/20 px-2 py-0.5 rounded-full text-xs">{orcamentosStatus.length}</span>
                                 </div>
                                 <div className="bg-gray-100 rounded-b-lg p-2 min-h-[200px] space-y-2">
                                   {orcamentosStatus.length === 0 ? (
                                     <div className="text-center text-gray-400 text-sm py-8">Nenhum or√ßamento</div>
                                   ) : (
                                     orcamentosStatus.map(orc => (
                                       <div key={orc.id} className="bg-white rounded-lg p-3 shadow-sm hover:shadow transition cursor-pointer" onClick={() => editarOrcamento(orc)}>
                                         <div className="flex justify-between items-start mb-2">
                                           <span className="text-xs font-mono text-gray-500">{orc.numero}</span>
                                           <span className="text-xs text-gray-400">{new Date(orc.dataSalvo).toLocaleDateString('pt-BR')}</span>
                                         </div>
                                         <h4 className="font-medium text-sm truncate">{orc.cliente.nome || 'Sem nome'}</h4>
                                         <p className="text-amber-600 font-bold mt-1">{formatCurrency(orc.totais?.total || 0)}</p>
                                         {/* Bot√µes de Avan√ßar/Voltar Status */}
                                         <div className="flex gap-1 mt-2 pt-2 border-t">
                                           {STATUS_PIPELINE.findIndex(s => s.id === status.id) > 0 && (
                                             <button onClick={(e) => { e.stopPropagation(); mudarStatus(orc.id, STATUS_PIPELINE[STATUS_PIPELINE.findIndex(s => s.id === status.id) - 1].id); }} 
                                               className="flex-1 text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded">‚Üê Voltar</button>
                                           )}
                                           {STATUS_PIPELINE.findIndex(s => s.id === status.id) < STATUS_PIPELINE.length - 2 && (
                                             <button onClick={(e) => { e.stopPropagation(); mudarStatus(orc.id, STATUS_PIPELINE[STATUS_PIPELINE.findIndex(s => s.id === status.id) + 1].id); }} 
                                               className="flex-1 text-xs bg-amber-100 hover:bg-amber-200 text-amber-700 px-2 py-1 rounded">Avan√ßar ‚Üí</button>
                                           )}
                                         </div>
                                       </div>
                                     ))
                                   )}
                                 </div>
                               </div>
                             );
                           })}
                           {/* Coluna de Cancelados - s√≥ aparece se filtro for 'todos' ou 'cancelado' */}
                           {(filtroStatus === 'todos' || filtroStatus === 'cancelado') && (
                             <div className={`${filtroStatus === 'todos' ? 'w-72' : 'w-96'} flex-shrink-0`}>
                               <div className="bg-red-500 text-white p-3 rounded-t-lg flex items-center justify-between">
                                 <span className="font-medium">‚ùå Cancelados</span>
                                 <span className="bg-white/20 px-2 py-0.5 rounded-full text-xs">{historico.filter(o => {
                                   const dataOrc = new Date(o.dataSalvo).toISOString().split('T')[0];
                                   const termoBusca = buscaHistorico.toLowerCase();
                                   const matchBusca = !buscaHistorico || 
                                     o.cliente?.nome?.toLowerCase().includes(termoBusca) ||
                                     o.cliente?.telefone?.includes(termoBusca) ||
                                     o.cliente?.cpfCnpj?.includes(termoBusca) ||
                                     o.numero?.toLowerCase().includes(termoBusca);
                                   return o.status === 'cancelado' && dataOrc >= filtroDataInicio && dataOrc <= filtroDataFim && matchBusca;
                                 }).length}</span>
                               </div>
                               <div className="bg-gray-100 rounded-b-lg p-2 min-h-[200px] space-y-2">
                                 {historico.filter(o => {
                                   const dataOrc = new Date(o.dataSalvo).toISOString().split('T')[0];
                                   const termoBusca = buscaHistorico.toLowerCase();
                                   const matchBusca = !buscaHistorico || 
                                     o.cliente?.nome?.toLowerCase().includes(termoBusca) ||
                                     o.cliente?.telefone?.includes(termoBusca) ||
                                     o.cliente?.cpfCnpj?.includes(termoBusca) ||
                                     o.numero?.toLowerCase().includes(termoBusca);
                                   return o.status === 'cancelado' && dataOrc >= filtroDataInicio && dataOrc <= filtroDataFim && matchBusca;
                                 }).length === 0 ? (
                                   <div className="text-center text-gray-400 text-sm py-8">Nenhum or√ßamento</div>
                                 ) : (
                                   historico.filter(o => {
                                     const dataOrc = new Date(o.dataSalvo).toISOString().split('T')[0];
                                     const termoBusca = buscaHistorico.toLowerCase();
                                     const matchBusca = !buscaHistorico || 
                                       o.cliente?.nome?.toLowerCase().includes(termoBusca) ||
                                       o.cliente?.telefone?.includes(termoBusca) ||
                                       o.cliente?.cpfCnpj?.includes(termoBusca) ||
                                       o.numero?.toLowerCase().includes(termoBusca);
                                     return o.status === 'cancelado' && dataOrc >= filtroDataInicio && dataOrc <= filtroDataFim && matchBusca;
                                   }).map(orc => (
                                     <div key={orc.id} className="bg-white rounded-lg p-3 shadow-sm opacity-60">
                                       <span className="text-xs font-mono text-gray-500">{orc.numero}</span>
                                       <h4 className="font-medium text-sm truncate line-through">{orc.cliente.nome || 'Sem nome'}</h4>
                                       <p className="text-gray-400 font-bold mt-1">{formatCurrency(orc.totais?.total || 0)}</p>
                                     </div>
                                   ))
                                 )}
                               </div>
                             </div>
                           )}
                         </div>
                       </div>
                     )
                    }
                  </div>
                )}
              </main>

              {/* Modal Add Item */}
              {showAddItem && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-slate-800 text-white"><h3 className="text-lg font-semibold">Adicionar Item</h3></div>
                    <div className="p-4 overflow-y-auto max-h-[60vh]">
                      {!itemSelecionado ? (
                        <>
                          <input type="text" placeholder="Buscar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full border rounded-lg px-3 py-2 mb-3" autoFocus />
                          <div className="space-y-1 max-h-80 overflow-y-auto">
                            {produtosFiltrados.slice(0,20).map(p => (
                              <div key={p.codigo} onClick={() => { setItemSelecionado(p); setCustoUnitario(p.preco); setDescricaoItem(p.nome); setMedidaLargura(''); setMedidaAltura(''); }} className="p-3 hover:bg-amber-50 cursor-pointer rounded-lg">
                                <div className="flex justify-between"><span className="font-medium">{p.nome}</span><span className="text-gray-500 text-sm">{formatCurrency(p.preco)}/{p.unidade || 'un'}</span></div>
                              </div>
                            ))}
                          </div>
                        </>
                      ) : (
                        <div className="space-y-4">
                          <div className="bg-amber-50 border border-amber-200 p-4 rounded-lg">
                            <p className="font-semibold">{itemSelecionado.nome}</p>
                            <p className="text-xs text-gray-500">Custo Base: {formatCurrency(itemSelecionado.preco)} / {itemSelecionado.unidade || 'un'}</p>
                          </div>
                          <div><label className="text-sm font-medium block mb-1">Descri√ß√£o</label><input type="text" value={descricaoItem} onChange={(e) => setDescricaoItem(e.target.value)} className="w-full border rounded-lg px-3 py-2" /></div>
                          
                          {/* Campos de Medidas - SEMPRE aparecem para cortinas */}
                          <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                            <p className="text-xs font-medium text-blue-700 mb-2">üìê Medidas do Ambiente</p>
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <label className="text-xs text-blue-600 block mb-1">Largura (m)</label>
                                <input type="number" value={medidaLargura} onChange={(e) => setMedidaLargura(e.target.value)} className="w-full border border-blue-200 rounded-lg px-3 py-2 text-center" placeholder="0.00" step="0.01" min="0" />
                              </div>
                              <div>
                                <label className="text-xs text-blue-600 block mb-1">Altura (m)</label>
                                <input type="number" value={medidaAltura} onChange={(e) => setMedidaAltura(e.target.value)} className="w-full border border-blue-200 rounded-lg px-3 py-2 text-center" placeholder="0.00" step="0.01" min="0" />
                              </div>
                            </div>
                            {medidaLargura && medidaAltura && (
                              <p className="text-xs text-blue-600 mt-2 text-center font-medium">= {(parseFloat(medidaLargura) * parseFloat(medidaAltura)).toFixed(2)} m¬≤</p>
                            )}
                          </div>
                          
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="text-sm font-medium block mb-1">
                                {medidaLargura && medidaAltura ? '√Årea (m¬≤)' : 'Quantidade'}
                              </label>
                              <input type="number" value={
                                (medidaLargura && medidaAltura) 
                                  ? (parseFloat(medidaLargura) * parseFloat(medidaAltura)).toFixed(2)
                                  : quantidade
                              } onChange={(e) => setQuantidade(e.target.value)} 
                              disabled={medidaLargura && medidaAltura}
                              className="w-full border rounded-lg px-3 py-2 text-lg font-bold text-center disabled:bg-gray-100" min="0.5" step="0.5" />
                            </div>
                            <div>
                              <label className="text-sm font-medium block mb-1 text-blue-600">Custo Unit√°rio (Edit√°vel)</label>
                              <input type="number" value={custoUnitario} onChange={(e) => setCustoUnitario(e.target.value)} className="w-full border rounded-lg px-3 py-2 text-lg font-bold text-center border-blue-300 bg-blue-50" />
                            </div>
                          </div>
                          <div className="bg-slate-800 text-white p-4 rounded-lg text-center">
                            <p className="text-gray-300 text-xs">Simula√ß√£o Venda (c/ Markup {orcamento.markup}%)</p>
                            <p className="text-2xl font-bold text-amber-400">{formatCurrency((parseFloat(custoUnitario || 0) * (1 + orcamento.markup/100)) * (
                              (medidaLargura && medidaAltura) 
                                ? (parseFloat(medidaLargura) * parseFloat(medidaAltura))
                                : parseFloat(quantidade)
                            ))}</p>
                          </div>
                        </div>
                      )}
                    </div>
                    <div className="p-4 border-t bg-gray-50 flex gap-3">
                      <button onClick={() => { setShowAddItem(false); setItemSelecionado(null); setSearchTerm(''); setQuantidade(1); setCustoUnitario(''); setDescricaoItem(''); setMedidaLargura(''); setMedidaAltura(''); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">{itemSelecionado ? '‚Üê Voltar' : 'Cancelar'}</button>
                      {itemSelecionado && <button onClick={adicionarItem} className="flex-1 py-2.5 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium">‚úì Adicionar</button>}
                    </div>
                  </div>
                </div>
              )}

              {/* Modal Preview/PDF */}
              {showPreview && (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50 overflow-auto">
                  <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                    <div className="p-4 border-b bg-slate-800 text-white flex justify-between items-center">
                      <h3 className="text-lg font-semibold">üìÑ Or√ßamento</h3>
                      <div className="flex gap-2">
                        <button onClick={gerarPDF} disabled={gerando} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium">{gerando ? '‚è≥...' : 'üì• PDF'}</button>
                        <button onClick={() => setShowPreview(false)} className="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">‚úï</button>
                      </div>
                    </div>
                    <div className="overflow-auto p-4 bg-gray-200 flex-1">
                      {/* WRAPPER PRINCIPAL DO PDF COM ALTURA AJUSTADA PARA A4 */}
                      <div ref={pdfRef} className="bg-white shadow-lg mx-auto pdf-content" style={{ width: '210mm', minHeight: '296mm', padding: '12mm 15mm', backgroundColor: '#ffffff' }}>
                        {/* Header */}
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '20px', paddingBottom: '15px', borderBottom: '2px solid #D4AF37' }}>
                          <div style={{ width: '120px', height: '60px', overflow: 'hidden' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="400 1100 2200 1000" width="120" height="60">
                              <path fill="#d4af37" d="M490.73,1613.42c69.93-22.03,141.23-39.62,213.39-52.63,72.31-13.03,145.42-21.39,218.8-25.1,73.69-3.73,147.54-2.62,221.11,2.88,74.09,5.54,147.79,15.19,221.18,26.63,74.1,11.55,147.91,24.87,221.82,37.59,73.83,12.71,147.8,24.79,222.15,34.04,66.04,8.21,132.38,13.91,198.92,15.53,65.01,1.58,130.18-.59,194.82-7.87,63.76-7.18,127.05-19.13,188.52-37.67,60.63-18.29,119.55-42.96,174.36-74.77,13.47-7.82,26.67-16.07,39.61-24.73,10.64-7.12.64-24.45-10.09-17.27-52.24,34.95-108.88,62.9-168.06,83.98-59.91,21.34-122.1,35.96-184.96,45.33-63.57,9.48-127.97,13.39-192.22,13.49-64.72.1-129.42-3.77-193.77-10.57-73.73-7.8-147.05-19.06-220.16-31.31-73.66-12.35-147.15-25.74-220.85-37.85-73.8-12.13-147.86-23.01-222.32-30.29-73.67-7.21-147.66-10.56-221.68-8.89-73.67,1.67-147.2,8.1-220.08,18.95-72.23,10.76-143.78,26.05-214.08,45.82-17.33,4.87-34.57,10.03-51.74,15.44-12.23,3.85-7.01,23.17,5.32,19.29h0Z"/>
                              <path fill="#d4af37" d="M490.73,1668.64c69.93-22.03,141.23-39.62,213.39-52.63,72.31-13.03,145.42-21.39,218.8-25.1,73.69-3.73,147.54-2.62,221.11,2.88,74.09,5.54,147.79,15.19,221.18,26.63,74.1,11.55,147.91,24.87,221.82,37.59,73.83,12.71,147.8,24.79,222.15,34.04,66.04,8.21,132.38,13.91,198.92,15.53,65.01,1.58,130.18-.59,194.82-7.87,63.76-7.18,127.05-19.13,188.52-37.67,60.63-18.29,119.55-42.96,174.36-74.77,13.47-7.82,26.67-16.07,39.61-24.73,10.64-7.12.64-24.45-10.09-17.27-52.24,34.95-108.88,62.9-168.06,83.98-59.91,21.34-122.1,35.96-184.96,45.33-63.57,9.48-127.97,13.39-192.22,13.49-64.72.1-129.42-3.77-193.77-10.57-73.73-7.8-147.05-19.06-220.16-31.31-73.66-12.35-147.15-25.74-220.85-37.85-73.8-12.13-147.86-23.01-222.32-30.29-73.67-7.21-147.66-10.56-221.68-8.89-73.67,1.67-147.2,8.1-220.08,18.95-72.23,10.76-143.78,26.05-214.08,45.82-17.33,4.87-34.57,10.03-51.74,15.44-12.23,3.85-7.01,23.17,5.32,19.29h0Z"/>
                              <path fill="#d4af37" d="M490.73,1723.92c69.93-22.03,141.23-39.62,213.39-52.63,72.31-13.03,145.42-21.39,218.8-25.1,73.69-3.73,147.54-2.62,221.11,2.88,74.09,5.54,147.79,15.19,221.18,26.63,74.1,11.55,147.91,24.87,221.82,37.59,73.83,12.71,147.8,24.79,222.15,34.04,66.04,8.21,132.38,13.91,198.92,15.53,65.01,1.58,130.18-.59,194.82-7.87,63.76-7.18,127.05-19.13,188.52-37.67,60.63-18.29,119.55-42.96,174.36-74.77,13.47-7.82,26.67-16.07,39.61-24.73,10.64-7.12.64-24.45-10.09-17.27-52.24,34.95-108.88,62.9-168.06,83.98-59.91,21.34-122.1,35.96-184.96,45.33-63.57,9.48-127.97,13.39-192.22,13.49-64.72.1-129.42-3.77-193.77-10.57-73.73-7.8-147.05-19.06-220.16-31.31-73.66-12.35-147.15-25.74-220.85-37.85-73.8-12.13-147.86-23.01-222.32-30.29-73.67-7.21-147.66-10.56-221.68-8.89-73.67,1.67-147.2,8.1-220.08,18.95-72.23,10.76-143.78,26.05-214.08,45.82-17.33,4.87-34.57,10.03-51.74,15.44-12.23,3.85-7.01,23.17,5.32,19.29h0Z"/>
                              <text style={{ fontFamily: 'Cormorant Garamond, serif', fontSize: '700px', fontWeight: '600', fill: '#1a2231' }} transform="translate(488.08 1440.83)"><tspan x="0" y="0">V</tspan><tspan x="411.6" y="0">elluxe</tspan></text>
                              <text style={{ fontFamily: 'Cormorant Garamond, serif', fontSize: '300px', fontStyle: 'italic', fontWeight: '500', fill: '#1a2231' }} transform="translate(1217.13 1965.24)"><tspan x="0" y="0">D</tspan><tspan x="185.1" y="0">ecor</tspan></text>
                            </svg>
                          </div>
                          <div style={{ textAlign: 'right' }}>
                            <h2 style={{ fontSize: '20px', fontWeight: '700', color: '#1a2231', margin: 0 }}>OR√áAMENTO</h2>
                            <p style={{ fontSize: '14px', fontWeight: '600', color: '#D4AF37', margin: '5px 0 0 0' }}>{orcamento.numero}</p>
                            <p style={{ fontSize: '11px', color: '#666', marginTop: '8px' }}>Data: {new Date(orcamento.data).toLocaleDateString('pt-BR')}<br/>Validade: {orcamento.validade} dias</p>
                          </div>
                        </div>
                        {/* Cliente */}
                        <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '8px', marginBottom: '20px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: '600', color: '#D4AF37', marginBottom: '10px', textTransform: 'uppercase' }}>Dados do Cliente</h3>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', fontSize: '12px' }}>
                            <div><strong>Nome:</strong> {orcamento.cliente.nome}</div>
                            <div><strong>Telefone:</strong> {orcamento.cliente.telefone}</div>
                            {orcamento.cliente.email && <div><strong>E-mail:</strong> {orcamento.cliente.email}</div>}
                          </div>
                          {orcamento.cliente.endereco && <div style={{ marginTop: '10px', fontSize: '12px', borderTop: '1px solid #ddd', paddingTop: '10px' }}><strong>Endere√ßo:</strong> {orcamento.cliente.endereco}, {orcamento.cliente.numero} {orcamento.cliente.bairro && `‚Ä¢ ${orcamento.cliente.bairro}`} {orcamento.cliente.cidade && `‚Ä¢ ${orcamento.cliente.cidade}/${orcamento.cliente.estado}`}</div>}
                        </div>
                        {/* Itens */}
                        <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '11px', marginBottom: '20px' }}>
                          <thead><tr style={{ backgroundColor: '#1a2231', color: 'white' }}>
                            <th style={{ padding: '10px', textAlign: 'left' }}>Descri√ß√£o</th>
                            <th style={{ padding: '10px', textAlign: 'center', width: '120px' }}>Medidas (L √ó A)</th>
                            <th style={{ padding: '10px', textAlign: 'right', width: '100px' }}>Valor</th>
                          </tr></thead>
                          <tbody>
                            {orcamento.itens.map((item, i) => {
                                const finalPrice = calcularPrecoFinalItem(item);
                                const medidas = item.medidaLargura && item.medidaAltura 
                                  ? `${item.medidaLargura}m √ó ${item.medidaAltura}m`
                                  : '-';
                                return (
                                    <tr key={item.id} style={{ borderBottom: '1px solid #eee', backgroundColor: i % 2 === 0 ? '#fff' : '#fafafa' }}>
                                        <td style={{ padding: '10px' }}>
                                          <strong>{item.nome || item.descricao?.split(' (')[0]}</strong>
                                          <br/><span style={{ color: '#888', fontSize: '10px' }}>{item.categoria}</span>
                                        </td>
                                        <td style={{ padding: '10px', textAlign: 'center', fontSize: '11px', fontWeight: '500' }}>{medidas}</td>
                                        <td style={{ padding: '10px', textAlign: 'right', fontWeight: '600' }}>{formatCurrency(finalPrice)}</td>
                                    </tr>
                                );
                            })}
                          </tbody>
                        </table>
                        {/* Totais */}
                        <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '20px' }}>
                          <div style={{ width: '250px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', padding: '12px', fontSize: '16px', fontWeight: '700', backgroundColor: '#1a2231', color: '#D4AF37', borderRadius: '6px', marginTop: '8px' }}><span>TOTAL:</span><span>{formatCurrency(totais.total)}</span></div>
                          </div>
                        </div>
                        {/* Condi√ß√µes */}
                        <div style={{ backgroundColor: '#f8f9fa', padding: '15px', borderRadius: '8px', fontSize: '11px', marginBottom: '20px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: '600', color: '#D4AF37', marginBottom: '10px', textTransform: 'uppercase' }}>Condi√ß√µes</h3>
                          <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <div><strong>Pagamento:</strong> {orcamento.formaPagamento}</div>
                            <div><strong>Prazo:</strong> {orcamento.prazoEntrega}</div>
                            <div><strong>Garantia:</strong> {orcamento.garantia}</div>
                            <div><strong>Validade:</strong> {orcamento.validade} dias</div>
                          </div>
                          {orcamento.observacoes && <div style={{ marginTop: '10px', borderTop: '1px solid #ddd', paddingTop: '10px' }}><strong>Obs:</strong> {orcamento.observacoes}</div>}
                        </div>
                        {/* Footer */}
                        <div style={{ borderTop: '2px solid #D4AF37', paddingTop: '15px', textAlign: 'center', fontSize: '10px', color: '#888' }}>
                          <p style={{ margin: '0 0 5px 0' }}><strong style={{ color: '#1a2231' }}>Velluxe Decor</strong> ‚Ä¢ Cortinas Sob Medida</p>
                          <p style={{ margin: 0 }}>üìç Cascavel, PR ‚Ä¢ üì± (45) 99811-3954 ‚Ä¢ üìß velluxedecor@gmail.com</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal Cadastro/Edi√ß√£o de Cliente */}
              {showClienteModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-slate-800 text-white">
                      <h3 className="text-lg font-semibold">{clienteEditando ? '‚úèÔ∏è Editar Cliente' : 'üë§ Novo Cliente'}</h3>
                    </div>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      salvarCliente({
                        nome: formData.get('nome'),
                        telefone: formData.get('telefone'),
                        email: formData.get('email'),
                        cpf_cnpj: formData.get('cpf_cnpj'),
                        endereco: formData.get('endereco'),
                        numero: formData.get('numero'),
                        complemento: formData.get('complemento'),
                        bairro: formData.get('bairro'),
                        cidade: formData.get('cidade'),
                        estado: formData.get('estado'),
                        cep: formData.get('cep')
                      });
                    }} className="p-4 space-y-4 overflow-y-auto max-h-[60vh]">
                      <div className="grid grid-cols-2 gap-3">
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Nome *</label><input name="nome" type="text" defaultValue={clienteEditando?.nome || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Telefone</label><input name="telefone" type="tel" defaultValue={clienteEditando?.telefone || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">E-mail</label><input name="email" type="email" defaultValue={clienteEditando?.email || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">CPF/CNPJ</label><input name="cpf_cnpj" type="text" defaultValue={clienteEditando?.cpf_cnpj || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">CEP</label><input name="cep" type="text" defaultValue={clienteEditando?.cep || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                      </div>
                      <div className="border-t pt-4 grid grid-cols-6 gap-3">
                        <div className="col-span-4"><label className="text-xs text-gray-500 block mb-1">Endere√ßo</label><input name="endereco" type="text" defaultValue={clienteEditando?.endereco || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">N√∫mero</label><input name="numero" type="text" defaultValue={clienteEditando?.numero || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-3"><label className="text-xs text-gray-500 block mb-1">Complemento</label><input name="complemento" type="text" defaultValue={clienteEditando?.complemento || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-3"><label className="text-xs text-gray-500 block mb-1">Bairro</label><input name="bairro" type="text" defaultValue={clienteEditando?.bairro || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-4"><label className="text-xs text-gray-500 block mb-1">Cidade</label><input name="cidade" type="text" defaultValue={clienteEditando?.cidade || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">UF</label><input name="estado" type="text" defaultValue={clienteEditando?.estado || 'PR'} maxLength={2} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                      </div>
                      <div className="flex gap-2 pt-4 border-t">
                        <button type="button" onClick={() => { setShowClienteModal(false); setClienteEditando(null); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                        <button type="submit" className="flex-1 py-2.5 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600">{clienteEditando ? 'Atualizar' : 'Cadastrar'}</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* Modal Selecionar Cliente */}
              {showSelecionarCliente && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-slate-800 text-white">
                      <h3 className="text-lg font-semibold">üìã Selecionar Cliente</h3>
                    </div>
                    <div className="p-4">
                      <input type="text" placeholder="üîç Buscar cliente..." value={buscaCliente} onChange={(e) => setBuscaCliente(e.target.value)} className="w-full border rounded-lg px-3 py-2 mb-4" />
                      <div className="max-h-[50vh] overflow-y-auto space-y-2">
                        {clientes.filter(c => 
                          c.nome?.toLowerCase().includes(buscaCliente.toLowerCase()) ||
                          c.telefone?.includes(buscaCliente)
                        ).length === 0 ? (
                          <div className="text-center text-gray-400 py-8">Nenhum cliente encontrado</div>
                        ) : (
                          clientes.filter(c => 
                            c.nome?.toLowerCase().includes(buscaCliente.toLowerCase()) ||
                            c.telefone?.includes(buscaCliente)
                          ).map(cliente => (
                            <div key={cliente.id} onClick={() => selecionarCliente(cliente)} className="p-3 border rounded-lg hover:bg-amber-50 hover:border-amber-300 cursor-pointer transition">
                              <p className="font-medium">{cliente.nome}</p>
                              <div className="flex gap-4 text-sm text-gray-500">
                                {cliente.telefone && <span>üì± {cliente.telefone}</span>}
                                {cliente.cidade && <span>üìç {cliente.cidade}/{cliente.estado}</span>}
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                    </div>
                    <div className="p-4 border-t bg-gray-50">
                      <button onClick={() => { setShowSelecionarCliente(false); setBuscaCliente(''); }} className="w-full py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal Cadastro/Edi√ß√£o de Fornecedor */}
              {showFornecedorModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-slate-800 text-white">
                      <h3 className="text-lg font-semibold">{fornecedorEditando ? '‚úèÔ∏è Editar Fornecedor' : 'üè≠ Novo Fornecedor'}</h3>
                    </div>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      salvarFornecedor({
                        nome: formData.get('nome'),
                        cnpj: formData.get('cnpj'),
                        telefone: formData.get('telefone'),
                        email: formData.get('email'),
                        cidade: formData.get('cidade'),
                        estado: formData.get('estado'),
                        observacoes: formData.get('observacoes')
                      });
                    }} className="p-4 space-y-4">
                      <div className="grid grid-cols-2 gap-3">
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Nome *</label><input name="nome" type="text" defaultValue={fornecedorEditando?.nome || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">CNPJ</label><input name="cnpj" type="text" defaultValue={fornecedorEditando?.cnpj || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Telefone</label><input name="telefone" type="tel" defaultValue={fornecedorEditando?.telefone || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">E-mail</label><input name="email" type="email" defaultValue={fornecedorEditando?.email || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Cidade</label><input name="cidade" type="text" defaultValue={fornecedorEditando?.cidade || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">UF</label><input name="estado" type="text" defaultValue={fornecedorEditando?.estado || 'PR'} maxLength={2} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Observa√ß√µes</label><textarea name="observacoes" defaultValue={fornecedorEditando?.observacoes || ''} className="border rounded-lg px-3 py-2 text-sm w-full" rows={2}></textarea></div>
                      </div>
                      <div className="flex gap-2 pt-4 border-t">
                        <button type="button" onClick={() => { setShowFornecedorModal(false); setFornecedorEditando(null); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                        <button type="submit" className="flex-1 py-2.5 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600">{fornecedorEditando ? 'Atualizar' : 'Cadastrar'}</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* Modal Cadastro/Edi√ß√£o de Produto */}
              {showProdutoModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-slate-800 text-white">
                      <h3 className="text-lg font-semibold">{produtoEditando ? '‚úèÔ∏è Editar Produto' : 'üì¶ Novo Produto'}</h3>
                    </div>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      salvarProduto({
                        codigo: formData.get('codigo'),
                        nome: formData.get('nome'),
                        categoria: formData.get('categoria'),
                        largura: parseFloat(formData.get('largura')) || null,
                        preco: parseFloat(formData.get('preco').replace(',', '.')) || 0,
                        unidade: formData.get('unidade'),
                        fornecedor_id: formData.get('fornecedor_id') || null
                      });
                    }} className="p-4 space-y-4 overflow-y-auto max-h-[60vh]">
                      <div className="grid grid-cols-2 gap-3">
                        <div><label className="text-xs text-gray-500 block mb-1">C√≥digo *</label><input name="codigo" type="text" defaultValue={produtoEditando?.codigo || ''} required className="border rounded-lg px-3 py-2 text-sm w-full font-mono" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Categoria</label><input name="categoria" type="text" defaultValue={produtoEditando?.categoria || ''} className="border rounded-lg px-3 py-2 text-sm w-full" list="categorias-list" />
                          <datalist id="categorias-list">
                            <option value="Blackout" /><option value="Tecido" /><option value="Forro" /><option value="Voil" />
                            <option value="Aviamento" /><option value="Trilho" /><option value="Suporte" /><option value="Persiana" />
                          </datalist>
                        </div>
                        <div className="col-span-2"><label className="text-xs text-gray-500 block mb-1">Nome do Produto *</label><input name="nome" type="text" defaultValue={produtoEditando?.nome || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Largura (m)</label><input name="largura" type="number" step="0.01" defaultValue={produtoEditando?.largura || ''} className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Unidade *</label>
                          <select name="unidade" defaultValue={produtoEditando?.unidade || 'metro'} required className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="metro">metro (m)</option>
                            <option value="m2">m¬≤ (metro quadrado)</option>
                            <option value="un">unidade (un)</option>
                            <option value="par">par</option>
                            <option value="pct">pacote (pct)</option>
                            <option value="rolo">rolo</option>
                            <option value="kit">kit</option>
                          </select>
                        </div>
                        <div><label className="text-xs text-gray-500 block mb-1">Pre√ßo Custo (R$) *</label><input name="preco" type="text" defaultValue={produtoEditando?.preco?.toFixed(2).replace('.', ',') || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" /></div>
                        <div><label className="text-xs text-gray-500 block mb-1">Fornecedor</label>
                          <select name="fornecedor_id" defaultValue={produtoEditando?.fornecedor_id || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            {fornecedores.map(f => <option key={f.id} value={f.id}>{f.nome}</option>)}
                          </select>
                        </div>
                      </div>
                      <div className="flex gap-2 pt-4 border-t">
                        <button type="button" onClick={() => { setShowProdutoModal(false); setProdutoEditando(null); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                        <button type="submit" className="flex-1 py-2.5 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600">{produtoEditando ? 'Atualizar' : 'Cadastrar'}</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* Modal Importar PDF */}
              {showImportarPDF && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-blue-600 text-white">
                      <h3 className="text-lg font-semibold">üìÑ Importar Produtos de PDF</h3>
                    </div>
                    <div className="p-4 space-y-4">
                      {produtosImportados.length === 0 ? (
                        <>
                          <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
                            <p className="font-medium text-blue-800 mb-2">üìã Instru√ß√µes:</p>
                            <ol className="list-decimal list-inside text-blue-700 space-y-1">
                              <li>Abra o PDF do fornecedor (S√≥ S√≥ Decor ou outro)</li>
                              <li>Selecione todo o texto (Ctrl+A) e copie (Ctrl+C)</li>
                              <li>Cole o conte√∫do na √°rea abaixo</li>
                              <li>Selecione o tipo de produto e o fornecedor</li>
                              <li>Clique em "Processar" para extrair os produtos</li>
                            </ol>
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <label className="text-xs text-gray-500 block mb-1">Tipo de Produto</label>
                              <select id="tipoProdutoImport" className="border rounded-lg px-3 py-2 text-sm w-full">
                                <option value="tecidos">Tecidos (C√≥digo | Nome | Largura | Pre√ßo)</option>
                                <option value="aviamentos">Aviamentos (Descri√ß√£o | Pre√ßo)</option>
                                <option value="persianas">Persianas (Nome | Pre√ßo √† vista | Pre√ßo cart√£o)</option>
                              </select>
                            </div>
                            <div>
                              <label className="text-xs text-gray-500 block mb-1">Fornecedor *</label>
                              <select id="fornecedorImport" className="border rounded-lg px-3 py-2 text-sm w-full" required>
                                <option value="">Selecione o fornecedor...</option>
                                {fornecedores.map(f => <option key={f.id} value={f.id}>{f.nome}</option>)}
                              </select>
                            </div>
                          </div>
                          <div>
                            <label className="text-xs text-gray-500 block mb-1">Conte√∫do copiado do PDF</label>
                            <textarea id="conteudoPDF" className="border rounded-lg px-3 py-2 text-sm w-full font-mono" rows={10} placeholder="Cole aqui o texto copiado do PDF..."></textarea>
                          </div>
                          <button onClick={() => {
                            const tipo = document.getElementById('tipoProdutoImport').value;
                            const texto = document.getElementById('conteudoPDF').value;
                            const fornecedorId = document.getElementById('fornecedorImport').value;
                            if (!fornecedorId) { alert('Selecione um fornecedor'); return; }
                            if (!texto.trim()) { alert('Cole o conte√∫do do PDF'); return; }
                            const produtos = parsearPDFSoSo(texto, tipo);
                            if (produtos.length === 0) { alert('Nenhum produto encontrado. Verifique o formato do texto.'); return; }
                            setProdutosImportados(produtos.map(p => ({ ...p, selecionado: true, fornecedor_id: fornecedorId })));
                          }} className="w-full py-2.5 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">üîç Processar PDF</button>
                        </>
                      ) : (
                        <>
                          <div className="bg-green-50 border border-green-200 rounded-lg p-3 text-sm text-green-800">
                            ‚úÖ {produtosImportados.filter(p => p.selecionado).length} de {produtosImportados.length} produtos selecionados para importa√ß√£o
                          </div>
                          <div className="max-h-[40vh] overflow-y-auto border rounded-lg">
                            <table className="w-full text-xs">
                              <thead className="bg-gray-50 sticky top-0">
                                <tr>
                                  <th className="p-2 text-left w-8"><input type="checkbox" checked={produtosImportados.every(p => p.selecionado)} onChange={(e) => setProdutosImportados(produtosImportados.map(p => ({ ...p, selecionado: e.target.checked })))} /></th>
                                  <th className="p-2 text-left">C√≥digo</th>
                                  <th className="p-2 text-left">Nome</th>
                                  <th className="p-2 text-center">Largura</th>
                                  <th className="p-2 text-right">Pre√ßo</th>
                                  <th className="p-2 text-center">Un</th>
                                </tr>
                              </thead>
                              <tbody>
                                {produtosImportados.map((prod, idx) => (
                                  <tr key={idx} className={`border-t ${prod.selecionado ? '' : 'opacity-40'}`}>
                                    <td className="p-2"><input type="checkbox" checked={prod.selecionado} onChange={(e) => {
                                      const novo = [...produtosImportados];
                                      novo[idx].selecionado = e.target.checked;
                                      setProdutosImportados(novo);
                                    }} /></td>
                                    <td className="p-2 font-mono">{prod.codigo}</td>
                                    <td className="p-2">{prod.nome}</td>
                                    <td className="p-2 text-center">{prod.largura ? `${prod.largura}m` : '-'}</td>
                                    <td className="p-2 text-right text-amber-600">{formatCurrency(prod.preco)}</td>
                                    <td className="p-2 text-center">{prod.unidade}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                          <div className="flex gap-2">
                            <button onClick={() => setProdutosImportados([])} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">‚Üê Voltar</button>
                            <button onClick={() => {
                              const selecionados = produtosImportados.filter(p => p.selecionado);
                              if (selecionados.length === 0) { alert('Selecione pelo menos um produto'); return; }
                              importarProdutosPDF(selecionados, selecionados[0].fornecedor_id);
                            }} disabled={importandoPDF} className="flex-1 py-2.5 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:opacity-50">
                              {importandoPDF ? '‚è≥ Importando...' : `‚úÖ Importar ${produtosImportados.filter(p => p.selecionado).length} Produtos`}
                            </button>
                          </div>
                        </>
                      )}
                    </div>
                    <div className="p-4 border-t bg-gray-50">
                      <button onClick={() => { setShowImportarPDF(false); setProdutosImportados([]); }} className="w-full py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Fechar</button>
                    </div>
                  </div>
                </div>
              )}

              {/* Modal Nova Transa√ß√£o */}
              {showTransacaoModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-amber-500 text-white">
                      <h3 className="text-lg font-semibold">{transacaoEditando ? '‚úèÔ∏è Editar Transa√ß√£o' : 'üí∞ Nova Transa√ß√£o'}</h3>
                    </div>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      salvarTransacao({
                        tipo: formData.get('tipo'),
                        categoria_id: formData.get('categoria_id') || null,
                        descricao: formData.get('descricao'),
                        valor: parseFloat(formData.get('valor').replace(',', '.')) || 0,
                        data_transacao: formData.get('data_transacao'),
                        forma_pagamento: formData.get('forma_pagamento'),
                        status: 'pago'
                      });
                    }} className="p-4 space-y-4">
                      <div className="grid grid-cols-2 gap-3">
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Tipo *</label>
                          <select name="tipo" defaultValue={transacaoEditando?.tipo || 'receita'} required className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="receita">üíµ Receita</option>
                            <option value="despesa">üí∏ Despesa</option>
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Categoria</label>
                          <select name="categoria_id" defaultValue={transacaoEditando?.categoria_id || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            {categoriasFinanceiras.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                          </select>
                        </div>
                        <div className="col-span-2">
                          <label className="text-xs text-gray-500 block mb-1">Descri√ß√£o *</label>
                          <input name="descricao" type="text" defaultValue={transacaoEditando?.descricao || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Valor (R$) *</label>
                          <input name="valor" type="text" defaultValue={transacaoEditando?.valor?.toString().replace('.', ',') || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Data *</label>
                          <input name="data_transacao" type="date" defaultValue={transacaoEditando?.data_transacao || new Date().toISOString().split('T')[0]} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div className="col-span-2">
                          <label className="text-xs text-gray-500 block mb-1">Forma de Pagamento</label>
                          <select name="forma_pagamento" defaultValue={transacaoEditando?.forma_pagamento || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="PIX">PIX</option>
                            <option value="Cart√£o D√©bito">Cart√£o D√©bito</option>
                            <option value="Cart√£o Cr√©dito">Cart√£o Cr√©dito</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Transfer√™ncia">Transfer√™ncia</option>
                          </select>
                        </div>
                      </div>
                      <div className="flex gap-2 pt-4 border-t">
                        <button type="button" onClick={() => { setShowTransacaoModal(false); setTransacaoEditando(null); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                        <button type="submit" className="flex-1 py-2.5 bg-amber-500 text-white rounded-lg font-medium hover:bg-amber-600">Salvar</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* Modal Conta a Pagar */}
              {showContaPagarModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-red-500 text-white">
                      <h3 className="text-lg font-semibold">{contaPagarEditando ? '‚úèÔ∏è Editar Conta' : 'üí∏ Nova Conta a Pagar'}</h3>
                    </div>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      salvarContaPagar({
                        categoria_id: formData.get('categoria_id') || null,
                        fornecedor_id: formData.get('fornecedor_id') || null,
                        descricao: formData.get('descricao'),
                        valor: parseFloat(formData.get('valor').replace(',', '.')) || 0,
                        data_vencimento: formData.get('data_vencimento'),
                        parcela_atual: parseInt(formData.get('parcela_atual')) || 1,
                        total_parcelas: parseInt(formData.get('total_parcelas')) || 1,
                        status: 'pendente'
                      });
                    }} className="p-4 space-y-4">
                      <div className="grid grid-cols-2 gap-3">
                        <div className="col-span-2">
                          <label className="text-xs text-gray-500 block mb-1">Descri√ß√£o *</label>
                          <input name="descricao" type="text" defaultValue={contaPagarEditando?.descricao || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Categoria</label>
                          <select name="categoria_id" defaultValue={contaPagarEditando?.categoria_id || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            {categoriasFinanceiras.filter(c => c.tipo === 'despesa').map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Fornecedor</label>
                          <select name="fornecedor_id" defaultValue={contaPagarEditando?.fornecedor_id || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            {fornecedores.map(f => <option key={f.id} value={f.id}>{f.nome}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Valor (R$) *</label>
                          <input name="valor" type="text" defaultValue={contaPagarEditando?.valor?.toString().replace('.', ',') || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Vencimento *</label>
                          <input name="data_vencimento" type="date" defaultValue={contaPagarEditando?.data_vencimento || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Parcela</label>
                          <input name="parcela_atual" type="number" min="1" defaultValue={contaPagarEditando?.parcela_atual || 1} className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Total Parcelas</label>
                          <input name="total_parcelas" type="number" min="1" defaultValue={contaPagarEditando?.total_parcelas || 1} className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                      </div>
                      <div className="flex gap-2 pt-4 border-t">
                        <button type="button" onClick={() => { setShowContaPagarModal(false); setContaPagarEditando(null); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                        <button type="submit" className="flex-1 py-2.5 bg-red-500 text-white rounded-lg font-medium hover:bg-red-600">Salvar</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}

              {/* Modal Conta a Receber */}
              {showContaReceberModal && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden">
                    <div className="p-4 border-b bg-green-500 text-white">
                      <h3 className="text-lg font-semibold">{contaReceberEditando ? '‚úèÔ∏è Editar Conta' : 'üíµ Nova Conta a Receber'}</h3>
                    </div>
                    <form onSubmit={(e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      salvarContaReceber({
                        categoria_id: formData.get('categoria_id') || null,
                        cliente_id: formData.get('cliente_id') || null,
                        descricao: formData.get('descricao'),
                        valor: parseFloat(formData.get('valor').replace(',', '.')) || 0,
                        data_vencimento: formData.get('data_vencimento'),
                        parcela_atual: parseInt(formData.get('parcela_atual')) || 1,
                        total_parcelas: parseInt(formData.get('total_parcelas')) || 1,
                        status: 'pendente'
                      });
                    }} className="p-4 space-y-4">
                      <div className="grid grid-cols-2 gap-3">
                        <div className="col-span-2">
                          <label className="text-xs text-gray-500 block mb-1">Descri√ß√£o *</label>
                          <input name="descricao" type="text" defaultValue={contaReceberEditando?.descricao || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Categoria</label>
                          <select name="categoria_id" defaultValue={contaReceberEditando?.categoria_id || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            {categoriasFinanceiras.filter(c => c.tipo === 'receita').map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Cliente</label>
                          <select name="cliente_id" defaultValue={contaReceberEditando?.cliente_id || ''} className="border rounded-lg px-3 py-2 text-sm w-full">
                            <option value="">Selecione...</option>
                            {clientes.map(c => <option key={c.id} value={c.id}>{c.nome}</option>)}
                          </select>
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Valor (R$) *</label>
                          <input name="valor" type="text" defaultValue={contaReceberEditando?.valor?.toString().replace('.', ',') || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Vencimento *</label>
                          <input name="data_vencimento" type="date" defaultValue={contaReceberEditando?.data_vencimento || ''} required className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Parcela</label>
                          <input name="parcela_atual" type="number" min="1" defaultValue={contaReceberEditando?.parcela_atual || 1} className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                        <div>
                          <label className="text-xs text-gray-500 block mb-1">Total Parcelas</label>
                          <input name="total_parcelas" type="number" min="1" defaultValue={contaReceberEditando?.total_parcelas || 1} className="border rounded-lg px-3 py-2 text-sm w-full" />
                        </div>
                      </div>
                      <div className="flex gap-2 pt-4 border-t">
                        <button type="button" onClick={() => { setShowContaReceberModal(false); setContaReceberEditando(null); }} className="flex-1 py-2.5 border rounded-lg text-gray-600 hover:bg-gray-100">Cancelar</button>
                        <button type="submit" className="flex-1 py-2.5 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600">Salvar</button>
                      </div>
                    </form>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // ==================== APP ====================
        function App() {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);

          useEffect(() => {
            supabase.auth.getSession().then(({ data: { session } }) => { setUser(session?.user ?? null); setLoading(false); });
            const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => { setUser(session?.user ?? null); });
            return () => subscription.unsubscribe();
          }, []);

          const handleLogout = async () => { await supabase.auth.signOut(); setUser(null); };

          if (loading) return <div className="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 flex items-center justify-center"><div className="text-center text-white"><h1 className="text-3xl font-serif mb-2">Velluxe Decor</h1><p className="text-amber-400">Carregando...</p></div></div>;
          if (!user) return <LoginScreen onLogin={setUser} />;
          return <VelluxeOrcamentos user={user} onLogout={handleLogout} />;
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>